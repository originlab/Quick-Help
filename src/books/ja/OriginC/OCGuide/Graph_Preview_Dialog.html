<h1 class="firstheading">グラフプレビュー付きダイアログ</h1><p>このセクションでは、グラフプレビュー付きカスタムダイアログの作成方法を示しています。
</p>
<div id="toc" class="toc"><div id="toctitle"><h2>目次</h2></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Prepare_Dialog_Resource"><span class="tocnumber">1</span> <span class="toctext">ダイアログリソースを準備</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="#Prepare_Source_File"><span class="tocnumber">2</span> <span class="toctext">ソースファイルを準備</span></a></li>
<li class="toclevel-1 tocsection-3"><a href="#Including_Needed_headers"><span class="tocnumber">3</span> <span class="toctext">必要なヘッダを含める</span></a></li>
<li class="toclevel-1 tocsection-4"><a href="#Adding_User_Defined_Preview_ClassClasses.2C_User_Defined"><span class="tocnumber">4</span> <span class="toctext">ユーザ定義プレビュークラスを作成<span class="OIndex" style="display:none">Classes, User Defined</span></span></a></li>
<li class="toclevel-1 tocsection-5"><a href="#Adding_Dialog_Class"><span class="tocnumber">5</span> <span class="toctext">ダイアログクラスを追加</span></a></li>
<li class="toclevel-1 tocsection-6"><a href="#Open_the_Dialog"><span class="tocnumber">6</span> <span class="toctext">ダイアログを開く</span></a></li>
</ul>
</div>

<h2><a name="Prepare_Dialog_Resource"></a><span class="mw-headline">ダイアログリソースを準備</span></h2>
<p>最初に、プレビューグラフが入れ子になった統計コントロールを含むダイアログリソースを作成します。ここでは、 <i>OriginC\Originlab\ODlg8.dll</i>に組み込まれたリソースである、 IDD_SAMPLE_SPLITTER_DLGを使用します。
</p>
<h2><a name="Prepare_Source_File"></a><span class="mw-headline">ソースファイルを準備</span></h2>
<p>コードビルダで、新規ボタン<a  class="image"><img alt="Newfile button.png" src="../images/Graph_Preview_Dialog/Newfile_button.png" width="23"  /></a> をクリックして、ファイル名を入力し、上述のダイアログリソースと同じパス（Originのインストールフォルダの<i>OriginC\Originlab</i> サブフォルダ）にセットします。
</p>
<h2><a name="Including_Needed_headers"></a><span class="mw-headline">必要なヘッダを含める</span></h2>
<pre class="oc" style="font-family:monospace;"><span style="color: #008000;">// これらのヘッダファイルは、ダイアログとコントロールの宣言を含む</span>
<span style="color: #0000ff;">#include</span> <span style="color: #000080;">&lt;</span>..\Originlab\DialogEx.<span style="color: #000000;">h</span><span style="color: #000080;">&gt;</span>
<span style="color: #0000ff;">#include</span> <span style="color: #000080;">&lt;</span>..\Originlab\GraphPageControl.<span style="color: #000000;">h</span><span style="color: #000080;">&gt;</span></pre>
<h2><a name="Adding_User_Defined_Preview_ClassClasses.2C_User_Defined"></a><span class="mw-headline">ユーザ定義プレビュークラスを作成<span class="OIndex" style="display:none">Classes, User Defined</span></span></h2>
<pre class="oc" style="font-family:monospace;"><span style="color: #008000;">//プレビューグラフのいくつかのアクションを禁止する</span>
<span style="color: #0000ff;">#define</span> PREVIEW_NOCLICK_BITS <span style="color: #000000;">(</span>NOCLICK_DATA_PLOT<span style="color: #000040;">|</span>NOCLICK_LAYER<span style="color: #000040;">|</span>NOCLICK_LAYERICON<span style="color: #000000;">)</span>

<span style="color: #0000ff;">#define</span> PREVIEW_TEMPLATE    <span style="color: #ff00ff;">&quot;Origin&quot;</span> <span style="color: #008000;">//グラフテンプレートのプレビュー</span>

<span style="color: #0000ff;">class</span>   MyPreviewCtrl
<span style="color: #000000;">{</span>
<span style="color: #0000ff;">public</span><span style="color: #000000;">:</span>
    MyPreviewCtrl<span style="color: #000000;">(</span><span style="color: #000000;">)</span><span style="color: #000000;">{</span><span style="color: #000000;">}</span>
    ~MyPreviewCtrl<span style="color: #000000;">(</span><span style="color: #000000;">)</span>
    <span style="color: #000000;">{</span>
        <span style="color: #008000;">//ダイアログを閉じたときに一時ブックを削除</span>
        <span style="color: #0000ff;">if</span> <span style="color: #000000;">(</span> m_wksPreview.<span style="color: #000000;">IsValid</span><span style="color: #000000;">(</span><span style="color: #000000;">)</span> <span style="color: #000000;">)</span>
            m_wksPreview.<span style="color: #000000;">Destroy</span><span style="color: #000000;">(</span><span style="color: #000000;">)</span>;
    <span style="color: #000000;">}</span>
    
    <span style="color: #0000ff;">void</span>    Init<span style="color: #000000;">(</span><span style="color: #0000ff;">int</span> nCtrlID, WndContainer<span style="color: #000040;">&amp;</span> wndParent<span style="color: #000000;">)</span>
    <span style="color: #000000;">{</span>
        <span style="color: #008000;">//プレビューグラフのコントロールを作成</span>
        Control ctrl <span style="color: #000080;">=</span> wndParent.<span style="color: #000000;">GetDlgItem</span><span style="color: #000000;">(</span>nCtrlID<span style="color: #000000;">)</span>;
        GraphControl gCtrl;
        gCtrl.<span style="color: #000000;">CreateControl</span><span style="color: #000000;">(</span>ctrl.<span style="color: #000000;">GetSafeHwnd</span><span style="color: #000000;">(</span><span style="color: #000000;">)</span><span style="color: #000000;">)</span>;
        gCtrl.<span style="color: #000000;">Visible</span> <span style="color: #000080;">=</span> <span style="color: #0000ff;">true</span>;
        
        GraphPageControl gpCtrl;
        gpCtrl.<span style="color: #000000;">Create</span><span style="color: #000000;">(</span>gCtrl, PREVIEW_NOCLICK_BITS, PREVIEW_TEMPLATE<span style="color: #000000;">)</span>;
        GraphPage gpPreview;
        gpPreview <span style="color: #000080;">=</span> gpCtrl.<span style="color: #000000;">GetPage</span><span style="color: #000000;">(</span><span style="color: #000000;">)</span>;
        gpPreview.<span style="color: #000000;">Rename</span><span style="color: #000000;">(</span><span style="color: #ff00ff;">&quot;MyPreview&quot;</span><span style="color: #000000;">)</span>;
        m_glPreview <span style="color: #000080;">=</span> gpPreview.<span style="color: #000000;">Layers</span><span style="color: #000000;">(</span><span style="color: #0000dd;">0</span><span style="color: #000000;">)</span>; <span style="color: #008000;">//第1レイヤ</span>
        
        <span style="color: #0000ff;">if</span> <span style="color: #000000;">(</span> <span style="color: #000040;">!</span>m_wksPreview <span style="color: #000000;">)</span>
        <span style="color: #000000;">{</span>
            <span style="color: #008000;">//プレビューデータを持つ一時ワークシート</span>
            m_wksPreview.<span style="color: #000000;">Create</span><span style="color: #000000;">(</span><span style="color: #ff00ff;">&quot;Origin&quot;</span>, CREATE_TEMP<span style="color: #000000;">)</span>;
            m_wksPreview.<span style="color: #000000;">SetSize</span><span style="color: #000000;">(</span><span style="color: #000040;">-</span><span style="color: #0000dd;">1</span>, <span style="color: #0000dd;">2</span><span style="color: #000000;">)</span>; <span style="color: #008000;">//2列</span>
            
            <span style="color: #008000;">//軸タイトルとしてロングネームを表示</span>
            Column colX<span style="color: #000000;">(</span>m_wksPreview, <span style="color: #0000dd;">0</span><span style="color: #000000;">)</span>;
            colX.<span style="color: #000000;">SetLongName</span><span style="color: #000000;">(</span><span style="color: #ff00ff;">&quot;Preview X&quot;</span><span style="color: #000000;">)</span>;
            Column colY<span style="color: #000000;">(</span>m_wksPreview, <span style="color: #0000dd;">1</span><span style="color: #000000;">)</span>;
            colY.<span style="color: #000000;">SetLongName</span><span style="color: #000000;">(</span><span style="color: #ff00ff;">&quot;Preview Y&quot;</span><span style="color: #000000;">)</span>;
            
            <span style="color: #008000;">//データ範囲を用意</span>
            DataRange drPrev;
            drPrev.<span style="color: #000000;">Add</span><span style="color: #000000;">(</span>m_wksPreview, <span style="color: #0000dd;">0</span>, <span style="color: #ff00ff;">&quot;X&quot;</span><span style="color: #000000;">)</span>;
            drPrev.<span style="color: #000000;">Add</span><span style="color: #000000;">(</span>m_wksPreview, <span style="color: #0000dd;">1</span>, <span style="color: #ff00ff;">&quot;Y&quot;</span><span style="color: #000000;">)</span>;
            
            <span style="color: #008000;">//プレビュー曲線をプロット。ここではポイントがない</span>
            <span style="color: #0000ff;">int</span> nPlot <span style="color: #000080;">=</span> m_glPreview.<span style="color: #000000;">AddPlot</span><span style="color: #000000;">(</span>drPrev, IDM_PLOT_LINE<span style="color: #000000;">)</span>;
            DataPlot dp <span style="color: #000080;">=</span> m_glPreview.<span style="color: #000000;">DataPlots</span><span style="color: #000000;">(</span>nPlot<span style="color: #000000;">)</span>;
            <span style="color: #0000ff;">if</span> <span style="color: #000000;">(</span> dp <span style="color: #000000;">)</span> <span style="color: #008000;">//プレビュー曲線色をセット</span>
                dp.<span style="color: #000000;">SetColor</span><span style="color: #000000;">(</span>SYSCOLOR_RED<span style="color: #000000;">)</span>;
        <span style="color: #000000;">}</span>
    <span style="color: #000000;">}</span>
    
    <span style="color: #008000;">//外部データとともにプレビュー曲線を更新</span>
    <span style="color: #0000ff;">void</span>    Update<span style="color: #000000;">(</span><span style="color: #0000ff;">const</span> vector<span style="color: #000040;">&amp;</span> vX, <span style="color: #0000ff;">const</span> vector<span style="color: #000040;">&amp;</span> vY<span style="color: #000000;">)</span>
    <span style="color: #000000;">{</span>
        <span style="color: #0000ff;">if</span> <span style="color: #000000;">(</span> m_wksPreview.<span style="color: #000000;">IsValid</span><span style="color: #000000;">(</span><span style="color: #000000;">)</span> <span style="color: #000000;">)</span>
        <span style="color: #000000;">{</span>
            Dataset dsX<span style="color: #000000;">(</span>m_wksPreview, <span style="color: #0000dd;">0</span><span style="color: #000000;">)</span>;
            Dataset dsY<span style="color: #000000;">(</span>m_wksPreview, <span style="color: #0000dd;">1</span><span style="color: #000000;">)</span>;
            <span style="color: #0000ff;">if</span> <span style="color: #000000;">(</span> <span style="color: #000040;">!</span>dsX.<span style="color: #000000;">IsValid</span><span style="color: #000000;">(</span><span style="color: #000000;">)</span> <span style="color: #000040;">||</span> <span style="color: #000040;">!</span>dsY.<span style="color: #000000;">IsValid</span><span style="color: #000000;">(</span><span style="color: #000000;">)</span> <span style="color: #000000;">)</span>
                <span style="color: #0000ff;">return</span>; <span style="color: #008000;">//プレビューのための列なし</span>
            
            <span style="color: #008000;">//ソースデータを更新するとプレビューグラフも更新</span>
            dsX <span style="color: #000080;">=</span> vX;
            dsY <span style="color: #000080;">=</span> vY;
            <span style="color: #008000;">//再スケール</span>
            m_glPreview.<span style="color: #000000;">Rescale</span><span style="color: #000000;">(</span><span style="color: #000000;">)</span>;
        <span style="color: #000000;">}</span>
    <span style="color: #000000;">}</span>
    
<span style="color: #0000ff;">private</span><span style="color: #000000;">:</span>
    <span style="color: #008000;">//ダイアログ上のプレビューグラフ</span>
    GraphLayer  m_glPreview;
    
    <span style="color: #008000;">//プレビューデータを置くための一時ワークシート</span>
    Worksheet   m_wksPreview;
<span style="color: #000000;">}</span>;</pre>
<h2><a name="Adding_Dialog_Class"></a><span class="mw-headline">ダイアログクラスを追加</span></h2>
<pre class="oc" style="font-family:monospace;"><span style="color: #0000ff;">class</span>   MyGraphPreviewDlg <span style="color: #000000;">:</span> <span style="color: #0000ff;">public</span> MultiPaneDlg
<span style="color: #000000;">{</span>
<span style="color: #0000ff;">public</span><span style="color: #000000;">:</span>
    <span style="color: #008000;">//ダイアログリソース ID と それを含むDLL</span>
    MyGraphPreviewDlg<span style="color: #000000;">(</span><span style="color: #000000;">)</span> <span style="color: #000000;">:</span> MultiPaneDlg<span style="color: #000000;">(</span>IDD_SAMPLE_SPLITTER_DLG, 
        GetAppPath<span style="color: #000000;">(</span><span style="color: #0000ff;">TRUE</span><span style="color: #000000;">)</span> <span style="color: #000040;">+</span> <span style="color: #ff00ff;">&quot;OriginC<span style="color: #666666; font-weight: bold;">\\</span>Originlab<span style="color: #666666; font-weight: bold;">\\</span>ODlg8&quot;</span><span style="color: #000000;">)</span>
    <span style="color: #000000;">{</span>
    <span style="color: #000000;">}</span>
    
    ~MyGraphPreviewDlg<span style="color: #000000;">(</span><span style="color: #000000;">)</span>
    <span style="color: #000000;">{</span>
    <span style="color: #000000;">}</span>
    
    <span style="color: #0000ff;">int</span>     DoModalEx<span style="color: #000000;">(</span>HWND hParent <span style="color: #000080;">=</span> <span style="color: #0000ff;">NULL</span><span style="color: #000000;">)</span>
    <span style="color: #000000;">{</span>
        InitMsgMap<span style="color: #000000;">(</span><span style="color: #000000;">)</span>;
        
        <span style="color: #008000;">//ユーザが閉じるまでダイアログ表示</span>
        <span style="color: #0000ff;">return</span> DoModal<span style="color: #000000;">(</span>hParent, DLG_NO_DEFAULT_REPOSITION<span style="color: #000000;">)</span>;
    <span style="color: #000000;">}</span>     
    
<span style="color: #0000ff;">protected</span><span style="color: #000000;">:</span>
EVENTS_BEGIN
	ON_INIT<span style="color: #000000;">(</span>OnInitDialog<span style="color: #000000;">)</span> 
	ON_BN_CLICKED<span style="color: #000000;">(</span>IDC_LOAD, OnDraw<span style="color: #000000;">)</span>
EVENTS_END

    <span style="color: #008000;">//ダイアログイベントのメッセージハンドラー</span>
    <span style="color: #0000ff;">BOOL</span>    OnInitDialog<span style="color: #000000;">(</span><span style="color: #000000;">)</span>;
    <span style="color: #0000ff;">BOOL</span>    OnDraw<span style="color: #000000;">(</span>Control ctrl<span style="color: #000000;">)</span>;
    
<span style="color: #0000ff;">private</span><span style="color: #000000;">:</span>
    <span style="color: #008000;">//プレビューコントロールを表すメンバー</span>
    MyPreviewCtrl       m_Preview;
<span style="color: #000000;">}</span>;

<span style="color: #0000ff;">BOOL</span> MyGraphPreviewDlg<span style="color: #000000;">::</span><span style="color: #000000;">OnInitDialog</span><span style="color: #000000;">(</span><span style="color: #000000;">)</span>
<span style="color: #000000;">{</span>
	m_Preview.<span style="color: #000000;">Init</span><span style="color: #000000;">(</span>IDC_FB_BOX, <span style="color: #000040;">*</span><span style="color: #0000ff;">this</span><span style="color: #000000;">)</span>;
	Button btn <span style="color: #000080;">=</span> GetItem<span style="color: #000000;">(</span>IDC_LOAD<span style="color: #000000;">)</span>;
	<span style="color: #0000ff;">if</span><span style="color: #000000;">(</span> btn <span style="color: #000000;">)</span>
		btn.<span style="color: #000000;">Text</span> <span style="color: #000080;">=</span> <span style="color: #ff00ff;">&quot;Draw&quot;</span>;
	<span style="color: #0000ff;">return</span> <span style="color: #0000ff;">true</span>;
<span style="color: #000000;">}</span>

<span style="color: #0000ff;">BOOL</span> MyGraphPreviewDlg<span style="color: #000000;">::</span><span style="color: #000000;">OnDraw</span><span style="color: #000000;">(</span>Control ctrl<span style="color: #000000;">)</span>
<span style="color: #000000;">{</span>
	vector vecX, vecY;
	vecX.<span style="color: #000000;">Data</span><span style="color: #000000;">(</span><span style="color: #0000dd;">1.0</span>, <span style="color: #0000dd;">10.0</span>, <span style="color: #0000dd;">0.5</span><span style="color: #000000;">)</span>;
	vecY.<span style="color: #000000;">SetSize</span><span style="color: #000000;">(</span>vecX.<span style="color: #000000;">GetSize</span><span style="color: #000000;">(</span><span style="color: #000000;">)</span><span style="color: #000000;">)</span>;	
	<span style="color: #0000ff;">for</span><span style="color: #000000;">(</span><span style="color: #0000ff;">int</span> ii <span style="color: #000080;">=</span> <span style="color: #0000dd;">0</span>; ii <span style="color: #000080;">&lt;</span> vecX.<span style="color: #000000;">GetSize</span><span style="color: #000000;">(</span><span style="color: #000000;">)</span>; <span style="color: #000040;">++</span>ii<span style="color: #000000;">)</span>
		vecY<span style="color: #000000;">[</span>ii<span style="color: #000000;">]</span> <span style="color: #000080;">=</span> rnd<span style="color: #000000;">(</span><span style="color: #000000;">)</span>;
	
	m_Preview.<span style="color: #000000;">Update</span><span style="color: #000000;">(</span>vecX, vecY<span style="color: #000000;">)</span>;
	<span style="color: #0000ff;">return</span> <span style="color: #0000ff;">true</span>;
<span style="color: #000000;">}</span></pre>
<h2><a name="Open_the_Dialog"></a><span class="mw-headline">ダイアログを開く</span></h2>
<pre class="oc" style="font-family:monospace;"><span style="color: #0000ff;">void</span> open_preview_dlg<span style="color: #000000;">(</span><span style="color: #000000;">)</span>
<span style="color: #000000;">{</span>
	MyGraphPreviewDlg dlg;
	dlg.<span style="color: #000000;">DoModalEx</span><span style="color: #000000;">(</span>GetWindow<span style="color: #000000;">(</span><span style="color: #000000;">)</span><span style="color: #000000;">)</span>;
	<span style="color: #0000ff;">return</span>;
<span style="color: #000000;">}</span></pre>
<p>上記関数を実行し、 <b>Draw </b>ボタンをクリックします。  すると、プレビューが更新されたのが確認できます。
</p>






    