<h1 class="firstheading">ピーク関数を定義する</h1><p class='urlname' style='display: none'>PeakAnalyzer-DefinePeakFunc</p>
<p><br />
<b>ピークアナライザ</b>を使ってピークをフィットするとき、「<b>ピークフィットのパラメータ</b>」ダイアログで各ピークに対して組み込み関数を選択したり、<b><a href="../../UserGuide/UserGuide/The_Fitting_Function_Organizer_Dialog_Box.html" title="ユーザガイド:フィット関数オーガナイザダイアログボックス"><b>フィット関数オーガナイザ</b></a></b>や<b><a href="../../UserGuide/Category/The_Fitting_Function_Builder.html" title="カテゴリー:フィット関数ビルダ">フィット関数ビルダ</a></b>で定義したユーザ定義関数を作成することができます。ピーク関数の定義は、<a href="../../UserGuide/UserGuide/User-Defined_Fitting_Functions.html" title="ユーザガイド:ユーザ定義フィット関数">ユーザ定義フィット関数</a>の作成とよく似ていますが、次の点が追加されています。
</p>
<ul><li> ピークアナライザで使用するには、関数を定義するときに関数が<b>PFW</b>カテゴリにあり、<b>ピーク関数</b>チェックボックスがオンになっている必要があります。</li>
<li> 他のカテゴリの既存のフィッティング機能をピークフィッティングで使用できるようにするには、<b>ツール: フィット関数オーガナイザ</b>を選択します。関数の上で右クリックし、<b>移動先</b>または<b>共有先</b>を選択して、表示されるダイアログのドロップダウンのリストオプションから、<b>PFW</b>を選択します。</li>
<li> ピーク関数を <a href="../../UserGuide/UserGuide/Quick_Peaks_Gadget.html" title="ユーザガイド:クイックピークガジェット">クイックピークガジェット</a> または <a href="../../UserGuide/UserGuide/Fitting_Multiple_Peaks_with_the_Multiple_Peak_Fit_Tool.html" title="ユーザーガイド：複数ピークフィットの機能による複数ピークフィット">複数ピークガジェットのピークフィットツール</a>に利用出来るようにするには、<b>ピーク関数</b>を選択します。</li>
<li> <b>ピークアナライザ</b>で基線をフィットする関数を定義する（OriginProのみ）には、 <b>基線</b> カテゴリーにユーザ定義関数を保存する必要があります。 </li>
<li> 少なくとも、関数には異なる特有のピークと関連する4つのパラメータがなければなりません。パラメータ属性は、フィット関数ビルダの<a href="../../UserGuide/UserGuide/The_Function_Body_Page.html#Dialog_Box_Controls" title="ユーザガイド:式形式の関数ページ"><b>式形式の関数</b>ページ</a>の<b>ピーク属性</b>列で設定されます。最初のパラメータは<b>y0</b>とされ、属性は<b>オフセット/基線</b>を割り当てられます。他のパラメータは任意の名前を指定できますが、必ず属性として<b>X中心</b>、<b>X幅</b>、<b>振幅/面積</b>を指定してください。</li></ul>
<table class="noborder"><tr>
	<td style="vertical-align:top" width="60"><img src="../images/Define_a_Peak_Function/Tip_icon.png" width="57"  border="0" /></td><td><p>同僚がFDFファイル（Origin関数定義ファイル）をあなたと共有している場合は、OriginワークスペースにドロップするだけでOriginに追加できます。
</p>
<ul><li> Origin 2018以降、カテゴリ情報はFDFファイルに保存されます。このファイルをOriginにドロップすると、作成者が指定したカテゴリにカテゴリが自動的に割り当てられます。</li>
<li> 以前のバージョンでは、FDFファイルをOriginワークスペースにドロップすると、<b>カテゴリーの選択</b>ダイアログが開き、カテゴリを割り当てることができます。</li></ul>
</td></tr></table>
<h2><a name="Example_1:_Origin_C"></a><span class="mw-headline">例 1：Origin C</span></h2>
<p>次のデモンストレーション例では、<b>ピークアナライザ</b>で使用されている、AsymmetricGaussと名付けられたピーク関数をどのように定義するかを説明します。
</p><p>定義されるピーク関数は次の通りです。
</p>
<dl><dd><i>double B,sig;</i></dd>
<dd><i>B=A/(0.5*(sig1+sig2)*sqrt(2*pi));</i></dd>
<dd><i>sig = x&lt;xc&nbsp;? sig1:sig2;</i></dd>
<dd><i>y = y0 + B * exp(-0.5 *((x-xc)/sig)^2);</i></dd></dl>
<p><i>x</i> は独立変数、<i>y</i> は従属変数、<i>y0</i>, <i>sig1</i>, <i>sig2</i>, <i>xc</i> は、それぞれ属性オフセット、ピーク範囲、左側ピーク幅、右側ピーク幅、ピーク中心に対応するパラメーターです。
</p><p><br />
<b><b>ピークアナライザ</b></b>でのピーク関数によるフィッティングを定義するには7つのステップがあります。
</p><p>1.キーボードで<b>F8</b> キーを押すか、メニューの<b>ツール：フィット関数ビルダー</b> を開きます。
</p><p>2.<b><b>進む</b></b>をクリックして、<b><b>関数名と関数形式</b></b>のページに移動し、<b><b>関数カテゴリーの選択/新規名称</b></b>のドロップダウンリストから<b><b>PFW</b></b>を選択し、<b><b>関数名</b></b>を<i>AsymmetricGauss</i>と入力します。<b>関数形式</b>のリストから<b>OriginC</b>を選びます。
</p><p>3.<b><b>進む</b></b>をクリックし、<b><b>変数とパラメーター</b></b>のページに移動します。変数とパラメーターを次のように入力し、<b><b>ピーク関数</b></b>にチェックを入れます。
</p>
<dl><dd><dl><dd><a  class="image"><img alt="Define Peak Function 01.png" src="../images/Define_a_Peak_Function/Define_Peak_Function_01.png" width="855"  /></a></dd></dl></dd></dl>
<p>4.<b>進む</b>をクリックし、<b>Origin C フィット関数</b>ページに移動します。<b>ピーク属性</b>の列にある全てのセルをそれぞれクリックし、それぞれのパラメーターをピーク属性に設定します。パラメータの初期値を入力します。それぞれのパラメーターに意味を入力します。<b>関数内容</b>の編集ボックスに関数式を入力し、次の図のように、クイックチェックに<i>X=1120</i>を入力して、表現が正しく記述されているかを確かめます。
</p>
<dl><dd><dl><dd><a  class="image"><img alt="Define Peak Function 02.png" src="../images/Define_a_Peak_Function/Define_Peak_Function_02.png" width="855"  /></a></dd></dl></dd></dl>
<p>5.<b>進む</b>ボタンをクリックし、<b>パラメーターの初期化ルーチン</b>のページに移動します。<b>次のコードを初期化コード</b>の編集欄に、次の図のように入力します。
</p>
<dl><dd><dl><dd><a  class="image"><img alt="Define Peak Function 03.png" src="../images/Define_a_Peak_Function/Define_Peak_Function_03.png" width="855"  /></a></dd></dl></dd></dl>
<p>6.<b>進む</b>をクリックし、<b><b>境界条件と一般線形制約</b></b>のページに移動します。&lt; or &lt;= 列のセルをトグルで切り替えるためにダブルクリックします。上限値、下限値を入力します。それぞれのパラメーターを入力すると、次に示すようにフィット結果を抽出する範囲を制限します。
</p>
<dl><dd><dl><dd><a  class="image"><img alt="Define Peak Function 04.png" src="../images/Define_a_Peak_Function/Define_Peak_Function_04.png" width="855"  /></a></dd></dl></dd></dl>
<p>7.<b><b>完了</b></b>ボタンをクリックすると、ピーク関数が作成され、<b><b>PFW</b></b>カテゴリーに割り当てられます。
</p><p>そして、<b>ピークフィットパラメータ</b>ダイアログの<b>ピークタイプ</b>ドロップダウンから、定義した関数を選択し、<b>ピークアナライザ</b>の中でこの関数でピークフィットを実行することができます。
</p>
<dl><dd><a  class="image"><img alt="Define Peak Function 05.png" src="../images/Define_a_Peak_Function/Define_Peak_Function_05.png" width="800"  /></a></dd></dl>
<h2><a name="Example_2:_Python"></a><span class="mw-headline">例 2：Python</span></h2>
<p><b>Origin 2021b</b>より、Pythonを使ってピークフィット関数を定義することができます。これらの関数は、ピークアナライザ、<a href="../../UserGuide/UserGuide/Fitting_Multiple_Peaks_with_the_Multiple_Peak_Fit_Tool.html" title="ユーザーガイド：複数ピークフィットの機能による複数ピークフィット">複数ピークフィットツール</a>、および<a href="../../UserGuide/UserGuide/Fitting_Multiple_Peaks_with_Replicas.html" title="ユーザガイド:複製を持つ複数ピークをフィットする">NLFitダイアログ</a>で使用できます。
</p>
<ol>
<li>フィット関数ビルダーを開き（<b>ツール：フィット関数ビルダー</b>または<b>F8</b>）、<b>新しい関数の作成</b>ラジオボタンを選択し、<b>進む</b>をクリックします。</li>
<li><b>関数カテゴリーの選択/新規名称</b>＝<i>PFW</i>、<b>関数名</b>＝<i>MyPyGaussV</i>、と設定します。<b>関数モデル</b>＝<b>陽関数</b>、<b>関数形式</b>＝<b>Python関数 (Vector)</b>、と設定します。</li>
<li> <b>独立変数</b>＝<i>x</i>, <b>従属変数</b>＝<i>y</i>と入力し、<b>パラメータ</b>には <i>y0</i>, <i>xc</i>, <i>A</i>, <i>w</i> と入力します（コンマで区切る必要があります）。 </li>
<li> <b>ピーク関数</b>にチェックを入れて<b>進む</b>をクリックします。</li>
<li> 次の情報を入力し、各行（各<b>パラメータ</b>）の<b>ピーク属性</b>ドロップダウンリストを必ず設定してください。</li>
<dl><dd><a  class="image"><img alt="FFB Mult Equations PythonV.png" src="../images/Define_a_Peak_Function/FFB_Mult_Equations_PythonV.png" width="621"  /></a></dd>
<dd> <i><b>Python関数 (Vector)</b></i></dd></dl>
<pre class="python" style="font-family:monospace;"><span style="color: #ff7700;font-weight:bold;">from</span> numpy <span style="color: #ff7700;font-weight:bold;">import</span> pi<span style="color: #000;">,</span> sqrt<span style="color: #000;">,</span> log<span style="color: #000;">,</span> exp
<span style="color: #ff7700;font-weight:bold;">def</span> pyGaussVector<span style="color: #000;">(</span>xvalues<span style="color: #000;">,</span>y0<span style="color: #000;">,</span>xc<span style="color: #000;">,</span>A<span style="color: #000;">,</span>w<span style="color: #000;">)</span>:
	<span style="color: #d00; font-style: italic;"># 組み込みのGaussian.FDFと同じ定義：</span>
	<span style="color: #d00; font-style: italic;">#yvalues = [y0 + A/(w*sqrt(pi/(4*log(2)))) * exp(-4*log(2)*(x-xc)*(x-xc)/(w*w)) for x in xvalues]</span>
	fct <span style="color: #000;">=</span> A/<span style="color: #000;">(</span>w*sqrt<span style="color: #000;">(</span>pi/<span style="color: #000;">(</span><span style="color: #000;">4</span>*log<span style="color: #000;">(</span><span style="color: #000;">2</span><span style="color: #000;">)</span><span style="color: #000;">)</span><span style="color: #000;">)</span><span style="color: #000;">)</span>
	inexp <span style="color: #000;">=</span> -<span style="color: #000;">4</span>*log<span style="color: #000;">(</span><span style="color: #000;">2</span><span style="color: #000;">)</span>/<span style="color: #000;">(</span>w*w<span style="color: #000;">)</span>
	yvalues <span style="color: #000;">=</span> <span style="color: #000;">[</span>y0 + fct * exp<span style="color: #000;">(</span>inexp*<span style="color: #000;">(</span>x-xc<span style="color: #000;">)</span>*<span style="color: #000;">(</span>x-xc<span style="color: #000;">)</span><span style="color: #000;">)</span> <span style="color: #ff7700;font-weight:bold;">for</span> x <span style="color: #ff7700;font-weight:bold;">in</span> xvalues<span style="color: #000;">]</span>
	<span style="color: #ff7700;font-weight:bold;">return</span> yvalues</pre>
<dl><dd> <i><b>関数内容</b></i></dd></dl>
<pre class="python" style="font-family:monospace;">y <span style="color: #000;">=</span> pyGaussVector<span style="color: #000;">(</span>x<span style="color: #000;">,</span>y0<span style="color: #000;">,</span>xc<span style="color: #000;">,</span>A<span style="color: #000;">,</span>w<span style="color: #000;">)</span></pre>
<dl><dd> <i>次のページ（<b>インストール前のスクリプト</b>ページ）は、関数に必要なPythonパッケージについて、ユーザのシステムをチェックするために使用されるLabTalkコードを指定するPythonのみのページです。空欄のままにすることはできません。</i> </dd></dl>
<li><b>進む</b>をクリックして<b>インストール前のスクリプト</b>ページに移動し、以下を追加します。
<dl><dd><a  class="image"><img alt="FFB Package Check PythonV.png" src="../images/Define_a_Peak_Function/FFB_Package_Check_PythonV.png" width="607"  /></a></dd>
<dd> <i><b>Pythonパッケージの確認(LabTalkスクリプト)</b></i></dd></dl>
<pre class="lt" style="font-family:monospace;">if<span style="color: #000000;">(</span>Python.<span style="color: #000080;">chk</span><span style="color: #000000;">(</span><span style="color: #ff00ff;">&quot;pandas cv2(opencv-python)&quot;</span><span style="color: #000000;">)</span> <span style="color: #000080;">&gt;</span> <span style="color: #0000dd;">1</span><span style="color: #000000;">)</span>
  return <span style="color: #0000dd;">1</span>;<span style="color: #008000;">// FDFをインストールしない</span>
return <span style="color: #0000dd;">0</span>;<span style="color: #008000;">//続行</span></pre>
<li>これ以上設定する必要はないので、<b>完了</b>をクリックして関数を保存し、ダイアログを閉じます。</li>
<li><b>データ：ファイルに接続： Text/CSV</b>を選択し、<i>&lt;Originプログラム&gt;\Samples\Curve Fitting</i>を開き、<b>MultiplePeaks.dat</b>を選択します。デフォルトのインポートオプションをそのままで、<b>OK</b>をクリックしてファイルを読み込みます。</li>
<li> 列<b>D(Y)</b>のヘッダをクリックして列を選択し、<b>散布図</b>ボタン<a  class="image"><img alt="Button Scatter.png" src="../images/Define_a_Peak_Function/Button_Scatter.png" width="22"  /></a>をクリックして散布図を作成します。</li>
<li><b>解析: ピークと基線: ピークアナライザー: ダイアログを開く</b>をクリックします。</li>
</li><b>目的</b>ページで<b>ピークフィット (Pro)</b>をチェックし、進むを4回クリックすると、<b>ピークフィット (Pro)</b>ページにたどり着きます。</li>
<li>ページの下の方にある<b>フィット制御</b>ボタンをクリックします。<b>ピークフィットパラメータ</b>ダイアログの中ほどにて、<i>Gaussian</i>から<i>MyPyGaussV (User)</i>に変更し、<b>OK</b>をクリックしてダイアログを閉じます。</li>
<li><b>完了</b>ボタンをクリックし、定義したユーザ定義Python関数で複数ピークをフィットします。</li>
<dl><dd><a  class="image"><img alt="FFB PythonV Results.png" src="../images/Define_a_Peak_Function/FFB_PythonV_Results.png" width="604"  /></a></dd></dl>
</li></ol>


    