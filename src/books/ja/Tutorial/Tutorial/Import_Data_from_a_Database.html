<h1 class="firstheading">データベースからデータをインポートする</h1>

  <p class='urlname' style='display: none'>ImpData-from-DB</p>

  <div id="toc" class="toc">
    <div id="toctitle">
      <h2>目次</h2>
    </div>

    <ul>
      <li class="toclevel-1 tocsection-1"><a href="#Summary"><span class="tocnumber">1</span> <span class="toctext">概要</span></a></li>

      <li class="toclevel-1 tocsection-2"><a href="#What_you_will_learn"><span class="tocnumber">2</span> <span class="toctext">学習する項目</span></a></li>

      <li class="toclevel-1 tocsection-3">
        <a href="#Steps"><span class="tocnumber">3</span> <span class="toctext">ステップ</span></a>

        <ul>
          <li class="toclevel-2 tocsection-4"><a href="#Import_data_using_SQL_Editor"><span class="tocnumber">3.1</span> <span class="toctext">SQLエディタを使ってデータをインポートする</span></a></li>

          <li class="toclevel-2 tocsection-5"><a href="#Reimport_from_Database"><span class="tocnumber">3.2</span> <span class="toctext">データベースから再インポートする</span></a></li>

          <li class="toclevel-2 tocsection-6"><a href="#LabTalk_Support_in_SQL_Editor"><span class="tocnumber">3.3</span> <span class="toctext">SQLエディタ内でのLabTalkサポート</span></a></li>
        </ul>
      </li>
    </ul>
  </div>

  <h2><a name="Summary"></a><span class="mw-headline">概要</span></h2>

  <table class="noborder">
    <tr>
      <td style="vertical-align:top" width="60"><img src="../images/Import_Data_from_a_Database/Alert_icon.png" width="57" border="0" alt=""></td>

      <td>
        <p>このチュートリアルは説明のみを目的としています。チュートリアルに示されている接続文字列は、インストールされたデータベースには接続しません。チュートリアルで説明したプロセスを実行できるように、独自のサーバーに AdventureWorks データベースをセットアップする場合は、<a class="external text" href="https://github.com/Microsoft/sql-server-samples/releases/tag/adventureworks" target="_blank">この GitHub ページ</a>を参照してください。</p>
      </td>
    </tr>
  </table>

  <p>Originでは、<b>SQLエディタ</b>を使ってデータベースからデータをインポートできます。</p>

  <p><b>SQLエディタ</b>は、SQLクエリの直接書き込みと編集が可能なエディタです。これは熟練のデータベースユーザにとって非常に便利で、ユーザはSQLスクリプトで LabTalk変数を定義できます。</p>

  <p>この機能では、繰り返し使用のために<b>データベース接続</b>は<b>ODS</b>ファイルに保存でき、<b>データベース接続とクエリ</b>は<b>ODQ</b>ファイルに保存できます。</p>

  <p>このチュートリアルでは、SQLサーバへの接続を構築する方法と、<b>SQLエディタ</b>を使用して特定の表から希望のデータを抽出する方法を示します。</p>

  <h2><a name="What_you_will_learn"></a><span class="mw-headline">学習する項目</span></h2>

  <p>このチュートリアルでは、以下の項目について解説します。</p>

  <ul>
    <li>SQLエディタを使ってデータベースからデータをインポートする</li>

    <li>データを再インポートする</li>

    <li>SQLエディタ内でのLabTalkサポート</li>
  </ul>

  <h2><a name="Steps"></a><span class="mw-headline">ステップ</span></h2>

  <p><font color="blue"><b>サーバマシン<i>noho</i>上にSQLサーバ<i>AdventureWorks2008</i>を予めセットアップ済であることを想定しています。</b></font></p>

  <h3><a name="Import_data_using_SQL_Editor"></a><span class="mw-headline">SQLエディタを使ってデータをインポートする</span></h3>

  <ol>
    <li>新しいプロジェクトを開始します。<b>データベースアクセス</b>ツールバーの<b>SQLエディタを開く</b>ボタンをクリックしてSQLエディタを起動します。<br>
    <a class="image"><img alt="ImportDataDatabase 1.png" src="../images/Import_Data_from_a_Database/ImportDataDatabase_1.png" width="275"></a><br>
    <a class="image"><img alt="SQL editor preview.png" src="../images/Import_Data_from_a_Database/SQL_Editor_Dialog1.png" width="558"></a></li>

    <li><i>AdventureWorks2008R2</i> データベースへの接続を作成します。<a class="image"><img alt="Db editor connect.png" src="../images/Import_Data_from_a_Database/Db_editor_connect.png" width="23"></a>ボタンをクリックするか<b>ファイル: 新規...</b>メニューを選択して<b>データリンクプロパティ</b>ダイアログを開きます。</li>

    <li><b>プロバイダー</b>タブでMicrosoft OLE DB Provider for SQL Serverを選択します。<b>次へ&gt;&gt;</b>ボタンをクリックします。<br>
    <a class="image"><img alt="SQL editor preview.png" src="../images/Import_Data_from_a_Database/SQL_Editor_Dialog2.png" width="421"></a></li>

    <li><b>接続</b>タブで、サーバ名、ログインユーザ名、パスワード（必要な場合。このサンプルではlabtalk2015）、データベース名を含むサーバの情報を指定します。<b>接続のテスト</b>をクリックして、接続可能かを確認します。<br>
    <a class="image"><img alt="SQL editor preview.png" src="../images/Import_Data_from_a_Database/SQL_Editor_Dialog3.png" width="421"></a></li>

    <li><b>OK</b> ボタンをクリックします。データベースAdventureWorks2008 内にある表が右側パネルにリストされます。接続文字列がメッセージタブにあります。<br>
      <a class="image"><img alt="SQL editor preview.png" src="../images/Import_Data_from_a_Database/SQL_Editor_Dialog4.png" width="558"></a><br>
      <i>あるいは、すでに接続文字列がある場合、<b>ファイル：接続文字列を編集...</b> メニューを選択して、<b>接続文字列エディタ</b>ダイアログを開きます。次のSQL文字列を入力し、<b>OK</b>をクリックして接続を作成します。<br></i>
      <pre class="sql" style="font-family:monospace;">
Provider<span style="color: #66cc66;">=</span>SQLOLEDB<span style="color: #66cc66;">.</span>1; Password<span style="color: #66cc66;">=</span>labtalk2015; Persist Security Info<span style="color: #66cc66;">=</span><span style="color: #993333; font-weight: bold;">TRUE</span>; <span style="color: #993333; font-weight: bold;">USER</span> ID<span style="color: #66cc66;">=</span><span style="color: #993333; font-weight: bold;">CONNECT</span>; Initial Catalog<span style="color: #66cc66;">=</span>AdventureWorks2008; <span style="color: #993333; font-weight: bold;">DATA</span> <span style="color: #993333; font-weight: bold;">SOURCE</span><span style="color: #66cc66;">=</span>noho
</pre>
    </li>

    <li><b>ファイル：接続を保存</b>を選択して、 <i>MyDataSource.ods</i> としてデータソースを保存します。</li>

    <li>ここで9つの表からデータを抽出し、employee表を構成します。ゼロからSQLスクリプトを書くことができます。左パネルのノードをダブルクリックすると、テーブルとフィールド名をエディタに追加できます。ここでは、以下のSQL文を右パネルにコピーします。<br>
      <pre class="sql" style="font-family:monospace;">
<span style="color: #993333; font-weight: bold;">SELECT</span> 
   e<span style="color: #66cc66;">.</span>BusinessEntityID<span style="color: #66cc66;">,</span> p<span style="color: #66cc66;">.</span>Title<span style="color: #66cc66;">,</span> p<span style="color: #66cc66;">.</span>FirstName<span style="color: #66cc66;">,</span> p<span style="color: #66cc66;">.</span>MiddleName<span style="color: #66cc66;">,</span> p<span style="color: #66cc66;">.</span>LastName<span style="color: #66cc66;">,</span> 
   p<span style="color: #66cc66;">.</span>Suffix<span style="color: #66cc66;">,</span> e<span style="color: #66cc66;">.</span>JobTitle<span style="color: #66cc66;">,</span> pp<span style="color: #66cc66;">.</span>PhoneNumber<span style="color: #66cc66;">,</span> pnt<span style="color: #66cc66;">.</span>Name <span style="color: #993333; font-weight: bold;">AS</span> PhoneNumberType<span style="color: #66cc66;">,</span> ea<span style="color: #66cc66;">.</span>EmailAddress<span style="color: #66cc66;">,</span> 
   p<span style="color: #66cc66;">.</span>EmailPromotion<span style="color: #66cc66;">,</span> a<span style="color: #66cc66;">.</span>AddressLine1<span style="color: #66cc66;">,</span> a<span style="color: #66cc66;">.</span>AddressLine2<span style="color: #66cc66;">,</span> a<span style="color: #66cc66;">.</span>City<span style="color: #66cc66;">,</span> sp<span style="color: #66cc66;">.</span>Name <span style="color: #993333; font-weight: bold;">AS</span> StateProvinceName<span style="color: #66cc66;">,</span>
   a<span style="color: #66cc66;">.</span>PostalCode<span style="color: #66cc66;">,</span> cr<span style="color: #66cc66;">.</span>Name <span style="color: #993333; font-weight: bold;">AS</span> CountryRegionName<span style="color: #66cc66;">,</span>  
   p<span style="color: #66cc66;">.</span>AdditionalContactInfo
<span style="color: #993333; font-weight: bold;">FROM</span> 
   HumanResources<span style="color: #66cc66;">.</span>Employee <span style="color: #993333; font-weight: bold;">AS</span> e <span style="color: #993333; font-weight: bold;">INNER</span> <span style="color: #993333; font-weight: bold;">JOIN</span> 
   Person<span style="color: #66cc66;">.</span>Person <span style="color: #993333; font-weight: bold;">AS</span> p <span style="color: #993333; font-weight: bold;">ON</span> p<span style="color: #66cc66;">.</span>BusinessEntityID <span style="color: #66cc66;">=</span> e<span style="color: #66cc66;">.</span>BusinessEntityID <span style="color: #993333; font-weight: bold;">INNER</span> <span style="color: #993333; font-weight: bold;">JOIN</span> 
   Person<span style="color: #66cc66;">.</span>BusinessEntityAddress <span style="color: #993333; font-weight: bold;">AS</span> bea <span style="color: #993333; font-weight: bold;">ON</span> bea<span style="color: #66cc66;">.</span>BusinessEntityID <span style="color: #66cc66;">=</span> e<span style="color: #66cc66;">.</span>BusinessEntityID <span style="color: #993333; font-weight: bold;">INNER</span> <span style="color: #993333; font-weight: bold;">JOIN</span> 
   Person<span style="color: #66cc66;">.</span>Address <span style="color: #993333; font-weight: bold;">AS</span> a <span style="color: #993333; font-weight: bold;">ON</span> a<span style="color: #66cc66;">.</span>AddressID <span style="color: #66cc66;">=</span> bea<span style="color: #66cc66;">.</span>AddressID <span style="color: #993333; font-weight: bold;">INNER</span> <span style="color: #993333; font-weight: bold;">JOIN</span> 
   Person<span style="color: #66cc66;">.</span>StateProvince <span style="color: #993333; font-weight: bold;">AS</span> sp <span style="color: #993333; font-weight: bold;">ON</span> sp<span style="color: #66cc66;">.</span>StateProvinceID <span style="color: #66cc66;">=</span> a<span style="color: #66cc66;">.</span>StateProvinceID <span style="color: #993333; font-weight: bold;">INNER</span> <span style="color: #993333; font-weight: bold;">JOIN</span> 
   Person<span style="color: #66cc66;">.</span>CountryRegion <span style="color: #993333; font-weight: bold;">AS</span> cr <span style="color: #993333; font-weight: bold;">ON</span> cr<span style="color: #66cc66;">.</span>CountryRegionCode <span style="color: #66cc66;">=</span> sp<span style="color: #66cc66;">.</span>CountryRegionCode <span style="color: #993333; font-weight: bold;">LEFT</span> <span style="color: #993333; font-weight: bold;">OUTER</span> <span style="color: #993333; font-weight: bold;">JOIN</span> 
   Person<span style="color: #66cc66;">.</span>PersonPhone <span style="color: #993333; font-weight: bold;">AS</span> pp <span style="color: #993333; font-weight: bold;">ON</span> pp<span style="color: #66cc66;">.</span>BusinessEntityID <span style="color: #66cc66;">=</span> p<span style="color: #66cc66;">.</span>BusinessEntityID <span style="color: #993333; font-weight: bold;">LEFT</span> <span style="color: #993333; font-weight: bold;">OUTER</span> <span style="color: #993333; font-weight: bold;">JOIN</span> 
   Person<span style="color: #66cc66;">.</span>PhoneNumberType <span style="color: #993333; font-weight: bold;">AS</span> pnt <span style="color: #993333; font-weight: bold;">ON</span> pp<span style="color: #66cc66;">.</span>PhoneNumberTypeID <span style="color: #66cc66;">=</span> pnt<span style="color: #66cc66;">.</span>PhoneNumberTypeID <span style="color: #993333; font-weight: bold;">LEFT</span> <span style="color: #993333; font-weight: bold;">OUTER</span> <span style="color: #993333; font-weight: bold;">JOIN</span> 
   Person<span style="color: #66cc66;">.</span>EmailAddress <span style="color: #993333; font-weight: bold;">AS</span> ea <span style="color: #993333; font-weight: bold;">ON</span> p<span style="color: #66cc66;">.</span>BusinessEntityID <span style="color: #66cc66;">=</span> ea<span style="color: #66cc66;">.</span>BusinessEntityID
<span style="color: #993333; font-weight: bold;">WHERE</span> sp<span style="color: #66cc66;">.</span>Name<span style="color: #66cc66;">=</span><span style="color: #ff0000;">&apos;Washington&apos;</span>
<span style="color: #993333; font-weight: bold;">ORDER</span> <span style="color: #993333; font-weight: bold;">BY</span> e<span style="color: #66cc66;">.</span>BusinessEntityID
</pre>
    </li>

    <li><b><b>結果データをプレビュー</b></b>ボタン<a class="image"><img alt="SQL editor preview.png" src="../images/Import_Data_from_a_Database/SQL_editor_preview.png" width="25"></a>をクリックしてデータをプレビューします。プレビューに問題なければ、<b>ワークシートにデータをインポート</b>ボタン<a class="image"><img alt="Button db Import Data.png" src="../images/Import_Data_from_a_Database/Button_db_Import_Data.png" width="25"></a>をクリックし、データをインポートします。インポートすると、ワークシートはデータベースと接続され、左上に黄色のアイコンが表示されます。<br>
    <a class="image"><img alt="SQL editor preview.png" src="../images/Import_Data_from_a_Database/SQL_Editor_Dialog19.png" width="396"></a></li>

    <li>メニューから<b>ファイル：接続とクエリーを新規に保存</b>を選択して、この接続とクエリーを<i>MyQuery.odq</i>として保存します。<b>SQLエディタ</b>を閉じます。</li>
  </ol>

  <h3><a name="Reimport_from_Database"></a><span class="mw-headline">データベースに再インポートする</span></h3>

  <p><b>SQLエディタ</b>を使用すると、接続とクエリーは自動でワークシートに保存されます。<b>データベースアクセス</b>ツールバーの、<b>データのインポート</b>ボタン<a class="image"><img alt="Button db Import Data.png" src="../images/Import_Data_from_a_Database/Button_db_Import_Data.png" width="25"></a>をクリックすれば、データベースからデータをいつでも再インポートできます。次のように操作してみましょう。</p>

  <ol>
    <li>データベース接続のワークシートでいくつかのデータを削除します。</li>

    <li><b>データのインポート</b>ボタン<a class="image"><img alt="Button db Import Data.png" src="../images/Import_Data_from_a_Database/Button_db_Import_Data.png" width="25"></a>をクリックします。データが元に戻るはずです。</li>

    <li>データベースを新しいワークブックにインポートするには、メニューから<b>ファイル：データベースインポート</b>を選択します。保存されたODQファイルのリストが表示されます。</li>

    <li>MyQuery.ODQを選択します。データベースからのデータが入力された、新しいワークブックが作成されます。</li>
  </ol>

  <table class="noborder">
    <tr>
      <td style="vertical-align:top" width="60"><img src="../images/Import_Data_from_a_Database/Tip_icon.png" width="57" border="0" alt=""></td>

      <td>
        <ol>
          <li>大規模なデータベースの場合、保存されたワークブックファイルも大規模なものになります。メニューから<b>ワークシート：ワークシートをクリア</b>を選択して、データをクリアし、ワークブックを保存できます。後にそのワークブックをロードして、<b>プレビューインポート</b><a class="image"><img alt="SQL editor preview.png" src="../images/Import_Data_from_a_Database/SQL_editor_preview.png" width="25"></a>をクリックしてデータの50行をプレビューでき、また、<b>データのインポート</b>ボタン<a class="image"><img alt="Button db Import Data.png" src="../images/Import_Data_from_a_Database/Button_db_Import_Data.png" width="25"></a>でデータベースからインポートすることもできます。</li>

          <li>クエリーを修正したい場合、ワークシートをアクティブにした状態で<b>SQLエディタ</b><a class="image"><img alt="Button Open SQL Editer.png" src="../images/Import_Data_from_a_Database/Button_Open_SQL_Editer.png" width="24"></a> をクリックします。</li>
        </ol>
      </td>
    </tr>
  </table>

  <h3><a name="LabTalk_Support_in_SQL_Editor"></a><span class="mw-headline">SQLエディタ内でのLabTalkサポート</span></h3>

  <p>上のサンプルでは、ワシントン州のデータのみインポートしました。しかし、それはコード化されていないので、別の州をクエリーしたい場合、クエリーを変更する必要があります。このセクションでは、州名のLabTalk文字列変数を定義してクエリーを簡単に変更できるようにする方法を示します。</p>

  <ol>
    <li>新規プロジェクトを開始します。メニューから<b><b>ファイル：データベースインポート：MyQuery.ODQ</b></b>を選択して、ワークシートに直接データをインポートします。</li>

    <li><b>SQLエディタを開く</b>ボタン<a class="image"><img alt="Button Open SQL Editer.png" src="../images/Import_Data_from_a_Database/Button_Open_SQL_Editer.png" width="24"></a>をクリックして<b>SQLエディタ</b>を開きます。</li>

    <li>LabTalk文字列変数を追加するために、<b>クエリー:LabTalk</b>と選択して<b>LabTalkサポート設定</b>ダイアログを開きます。<br>
    <a class="image"><img alt="SQL editor preview.png" src="../images/Import_Data_from_a_Database/SQL_Editor_Dialog8.png" width="533"></a></li>

    <li><b>LabTalk (%,$) 置換をする</b> にチェックをつけます。</li>

    <li>ワシントン州を表すLabTalk文字列変数<b>strCond</b>を定義するために、以下のスクリプトを入力します。
      <pre class="lt" style="font-family:monospace;">
string strCond<span style="color: #000080;">$</span> <span style="color: #000080;">=</span> <span style="color: #ff00ff;">&quot;Washington&quot;</span>;
</pre>これを<b>クエリー前のスクリプト</b> に入力します。<b>OK</b>をクリックします。<br>
      <a class="image"><img alt="SQL editor preview.png" src="../images/Import_Data_from_a_Database/SQL_Editor_Dialog9.png" width="533"></a>
    </li>

    <li>右パネルのSQL文の最後で、<b>WHERE</b>文を次のように変更します。
      <pre class="sql" style="font-family:monospace;">
 <span style="color: #993333; font-weight: bold;">WHERE</span> sp<span style="color: #66cc66;">.</span>name <span style="color: #66cc66;">=</span> <span style="color: #ff0000;">&apos;%(strCond$)&apos;</span>
</pre>
    </li>

    <li><a class="image"><img alt="Db editor connect.png" src="../images/Import_Data_from_a_Database/Db_editor_labtalk.png" width="23"></a>ボタンをクリックしてSQL編集ボックス内のSQLクエリー文字列をプレビューします。<br>
    <a class="image"><img alt="SQL editor preview.png" src="../images/Import_Data_from_a_Database/SQL_Editor_Dialog10.png" width="618"></a></li>

    <li><b>データのインポート</b>ボタン<a class="image"><img alt="Button db Import Data.png" src="../images/Import_Data_from_a_Database/Button_db_Import_Data.png" width="25"></a>をクリックし、データをインポートします。ダイアログを閉じ、ワークシートにSQLクエリーを再保存するために、<b>はい</b>を選択します。</li>

    <li>これで、<b>LabTalkサポート設定</b>ダイアログのstrCond$を変更するだけで州名を変更できるようになり、SQLクエリーを変更する必要はありません。</li>
  </ol>
