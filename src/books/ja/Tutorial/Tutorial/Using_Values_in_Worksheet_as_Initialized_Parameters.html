<h1 class="firstheading">NLFit内でLabTalkを使用してパラメータ初期化を行う</h1><p class='urlname' style='display: none'>CellVal-IniPara-Fitting</p>
<p><br />
</p>
<div id="toc" class="toc"><div id="toctitle"><h2>目次</h2></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Summary"><span class="tocnumber">1</span> <span class="toctext">概要</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="#What_you_will_learn"><span class="tocnumber">2</span> <span class="toctext">学習する項目</span></a></li>
<li class="toclevel-1 tocsection-3"><a href="#Steps"><span class="tocnumber">3</span> <span class="toctext">ステップ</span></a>
<ul>
<li class="toclevel-2 tocsection-4"><a href="#Write_Parameter_Initialization_Script_for_a_User-Defined_Fitting_Function"><span class="tocnumber">3.1</span> <span class="toctext">ユーザ定義フィット関数でパラメータ初期化スクリプトを作成する</span></a></li>
<li class="toclevel-2 tocsection-5"><a href="#Fit_Data_with_the_User_Defined_Fitting_Function"><span class="tocnumber">3.2</span> <span class="toctext">ユーザ定義フィット関数を使用してデータをフィットする</span></a></li>
<li class="toclevel-2 tocsection-6"><a href="#Create_an_Analysis_Template_and_Do_Batch_Processing"><span class="tocnumber">3.3</span> <span class="toctext">分析テンプレートを作成してバッチ処理を行う</span></a></li>
</ul>
</li>
</ul>
</div>
<p><br />
</p>
<table class="simple" style="width: 80%">
<tr style="vertical-align: top;">
<td style="width: 40%"><a  class="image"><img alt="Video Image.png" src="../images/Using_Values_in_Worksheet_as_Initialized_Parameters/Video_Image.png" width="33"  /></a> <a  class="image"><img alt="Video Text Image.png" src="../images/Using_Values_in_Worksheet_as_Initialized_Parameters/Video_Text_Image.png" width="135"  /></a>
<ul><li> <a class="external text" href="https://www.originlab.com/jwplayer.html?v=ftp/mm_tutorials/mp4/Fit_by_User_Functions.mp4%7C767%7C600" target="_blank">ユーザ定義フィット関数</a></li>
<li> <a class="external text" href="https://www.originlab.com/jwplayer.html?v=ftp/mm_tutorials/mp4/VT-2560_Batch_Process_MultiData_in_one_Workbook_in_Origin_2016.mp4%7C767%7C600" target="_blank">Batch Import and Analysis of Groups of Files</a></li>
<li> <a class="external text" href="https://www.originlab.com/jwplayer.html?v=ftp/mm_tutorials/mp4/Use_Clone_Import_to_batch_process_more_data_files.mp4%7C767%7C600" target="_blank">Use Clone Import to Batch Process More Data Files</a></li></ul>
</td>
<td style="width: 40%"><a  class="image"><img alt="Website blog icon circle.png" src="../images/Using_Values_in_Worksheet_as_Initialized_Parameters/Website_blog_icon_circle.png" width="31"  /></a> <a  class="image"><img alt="Blog Image 33x33px.png" src="../images/Using_Values_in_Worksheet_as_Initialized_Parameters/Blog_Image_33x33px.png" width="135"  /></a>
<ul><li> <a class="external text" href="http://blog.originlab.com/use-initial-formula-to-better-guess-fitting-parameter-values-from-data" target="_blank">Use Initial Formula to Better Guess Fitting Parameter Values from Data</a></li></ul>
</td></tr></table>
<h2><a name="Summary"></a><span class="mw-headline">概要</span></h2>
<p>以前のバージョンのOriginでは、フィットパラメータの初期化を行うのにOriginCコードを使用する必要がありました。Origin9.0 SR1以降では、LabTalkスクリプトを使用して初期化パラメータを設定できるようになりました。これは、ワークシートの値を初期パラメータとして使用したい時などに特に便利です。
</p><p>このチュートリアルでは、3つの異なる気温に対してそれぞれの吸着摂取曲線を描き、結果を3つの.txt ファイルにエクスポートする方法を学びます。数の条件はヘッダ情報と同じ.txt ファイルに保存されています。isothermal-sphericalモデルの以下の数式を使用してデータをフィットします。
</p><p><img src="../images/Using_Values_in_Worksheet_as_Initialized_Parameters/math-c99952a18855fe1f14788fe2100640c2.png" title="y = 1 - \frac{6}{pi^2}*exp(-\frac{pi^2}{T}*x)" alt="y = 1 - \frac{6}{pi^2}*exp(-\frac{pi^2}{T}*x)" class="tex"/> 
</p><p>ここで、yは正規化された摂取質量(mg/g)、xは時間帯(s)、Tは時間定数(1/s)、それとフィットパラメータです。 
</p><p>時間定数と温度の関係については以下の経験式から説明されます。
</p><p><img src="../images/Using_Values_in_Worksheet_as_Initialized_Parameters/math-aee6cb23be6aabd5140fb4b7213cf3ca.png" title="T = 25000 - 58 * Temp" alt="T = 25000 - 58 * Temp" class="tex"/>
</p><p>各温度の摂取曲線では、この経験式からTを計算し、その値を初期値として曲線フィットに使用します。
</p>
<p class="version" >必要なOriginのバージョン: Origin 9.0 SR1以降</p>
<h2><a name="What_you_will_learn"></a><span class="mw-headline">学習する項目</span></h2>
<p>このチュートリアルでは、以下の項目について解説します。
</p>
<ul><li>ユーザ定義のフィット関数を定義し、LabTalkスクリプトを使用してパラメータ初期化を行う</li>
<li>ワークシート内の値を初期パラメータとして使用する</li></ul>
<h2><a name="Steps"></a><span class="mw-headline">ステップ</span></h2>
<h3><a name="Write_Parameter_Initialization_Script_for_a_User-Defined_Fitting_Function"></a><span class="mw-headline">ユーザ定義フィット関数でパラメータ初期化スクリプトを作成する</span></h3>
<ol><li><b>ツール:フィット関数ビルダ</b>（または <b>F8</b>キーを押す）と選択して<b>フィット関数ビルダ</b>を開きます。<b>処理のゴール</b>ページで<b>新しい関数の作成</b>を選択して<b>進む</b>をクリックします。</li>
<li><b>関数名と関数形式</b>のページでは、関数が<b>User Defined</b>カテゴリーの中に作成されるようにします。関数名をとして<b>UptakeCurveFit</b>を入力し、<b>関数モデル</b>は<b>陽関数</b>、<b>関数式</b>は <b>OriginC</b>とします。<b><b>進む</b></b>ボタンをクリックします。</li>
<li><b>変数とパラメータ</b>ページでは、<b>独立変数</b>と<b>従属変数</b>をぞれぞれデフォルトのままである<b>x</b>と<b>y</b>にします。<b>パラメータ</b>を<b>T</b>として、<b>進む</b>をクリックします。</li>
<li><b>Origin Cフィット関数</b>ページでは、以下の数式を<b>関数内容</b>集ボックスに入力して<b>進む</b>をクリックします。</li></ol>
<pre class="oc" style="font-family:monospace;">y <span style="color: #000080;">=</span> <span style="color: #0000dd;">1</span> <span style="color: #000040;">-</span> <span style="color: #0000dd;">6</span><span style="color: #000040;">/</span><span style="color: #000000;">(</span>pi<span style="color: #000040;">^</span><span style="color: #0000dd;">2</span><span style="color: #000000;">)</span><span style="color: #000040;">*</span><span style="color: #000000;">exp</span><span style="color: #000000;">(</span><span style="color: #000040;">-</span><span style="color: #000000;">(</span>pi<span style="color: #000040;">^</span><span style="color: #0000dd;">2</span><span style="color: #000040;">/</span>T<span style="color: #000000;">)</span><span style="color: #000040;">*</span>x<span style="color: #000000;">)</span></pre>
<p><a  class="image"><img alt="Tutorial LT Para Init 01.png" src="../images/Using_Values_in_Worksheet_as_Initialized_Parameters/Tutorial_LT_Para_Init_01.png" width="678"  /></a>
</p>
<ol start="5">
<li><b>パラメータ初期化コード</b>のページでは、<b>カスタムコードを使用する</b>のラジオボタンを選択して、<b>LabTalkを利用</b>のラジオボタンを選択して、Labtalkスクリプトを利用できるようにします。<b><b>初期化コード</b></b>編集ボックスに、以下のコードを入力します。
<pre class="lt" style="font-family:monospace;"><span style="color: #008000;">//パラメータ初期化で実行するコード</span>
<span style="color: #008000;">//現在のワークシートを取得</span>
range rpage<span style="color: #000080;">=</span>ry.<span style="color: #000080;">getpage</span><span style="color: #000000;">(</span><span style="color: #000000;">)</span><span style="color: #000080;">$</span>;  
<span style="color: #008000;">//ワークシートデータを取得</span>
range rlayer<span style="color: #000080;">=</span>ry.<span style="color: #000080;">getlayer</span><span style="color: #000000;">(</span><span style="color: #000000;">)</span><span style="color: #000080;">$</span>; 
<span style="color: #008000;">//ワークシートデータのインデックスを取得</span>
int inext<span style="color: #000080;">=</span>rlayer.<span style="color: #000080;">index</span>;
<span style="color: #008000;">//データワークブックがアクティブである事を確認</span>
win <span style="color: #000080;">-</span>a <span style="color: #000080;">%</span><span style="color: #000000;">(</span>ry.<span style="color: #000080;">getpage</span><span style="color: #000000;">(</span><span style="color: #000000;">)</span><span style="color: #000080;">$</span><span style="color: #000000;">)</span>;
<span style="color: #008000;">//データワークシートがアクティブである事を確認</span>
page.<span style="color: #000080;">active</span><span style="color: #000080;">=</span>inext;
<span style="color: #008000;">//データワークシートの列2をアクティブ化</span>
wks.<span style="color: #000080;">col</span><span style="color: #000080;">=</span><span style="color: #0000dd;">2</span>;
<span style="color: #008000;">//列の内容から温度を文字列として取得</span>
string str1<span style="color: #000080;">$</span> <span style="color: #000080;">=</span> wks.<span style="color: #000080;">col</span>.<span style="color: #000080;">comment</span><span style="color: #000080;">$</span>;
<span style="color: #008000;">//温度の数字を文字列から取得</span>
string str2<span style="color: #000080;">$</span> <span style="color: #000080;">=</span> str1.<span style="color: #000080;">Left</span><span style="color: #000000;">(</span><span style="color: #0000dd;">3</span><span style="color: #000000;">)</span><span style="color: #000080;">$</span>;
<span style="color: #008000;">//文字列の値から倍精度の数値に変換</span>
double Temp <span style="color: #000080;">=</span> <span style="color: #000080;">%</span><span style="color: #000000;">(</span>str2<span style="color: #000080;">$</span><span style="color: #000000;">)</span>; 
<span style="color: #008000;">//経験式を使用してTの初期値を計算</span>
T<span style="color: #000080;">=</span><span style="color: #0000dd;">25000</span> <span style="color: #000080;">-</span> <span style="color: #0000dd;">58</span> <span style="color: #000080;">*</span> Temp; 
<span style="color: #008000;">//パラメータ初期化スクリプトが正確に実行されるか確認</span>
type <span style="color: #000080;">-</span>b <span style="color: #ff00ff;">&quot;Experimental temperature is $(Temp) K, so the initial value of T is $(T).&quot;</span></pre>
<table class="note">
<tr>
<td><b>Notes:</b>上記スクリプト内の<i>ry</i>は、パラメータ<i>y</i>の入力データ範囲に関する自動決定範囲変数です。このような範囲変数に関するシンタックスは「<i>r</i>+<i>parameter name</i>」になります。例えば、パラメータ名が<i>Temp</i>の場合、範囲変数は<i>rTemp</i>になります。
</td></tr></table>
</li>
<li>
<b>完了</b>をクリックしてユーザ定義フィット関数<b>UptakeCurveFit</b>の定義を終了します。<b>ユーザファイルフォルダ</b>に.fdfファイルが保存されているはずです。
</li>
</ol>
<h3><a name="Fit_Data_with_the_User_Defined_Fitting_Function"></a><span class="mw-headline">ユーザ定義フィット関数を使用してデータをフィットする</span></h3>
<ol><li><b>標準</b>ツールバーの新規プロジェクトボタン<a  class="image"><img alt="Button New Project.png" src="../images/Using_Values_in_Worksheet_as_Initialized_Parameters/Button_New_Project.png" width="22"  /></a>をクリックして、新しい行列を作成します。<a  class="image"><img alt="Button Import Wizard.png" src="../images/Using_Values_in_Worksheet_as_Initialized_Parameters/Button_Import_Wizard.png" width="25"  /></a>ボタンをクリック（または、メニューの<b>データ：ファイルからインポート：インポートウィザード</b>と操作、または<b>Ctrl</b>+<b>3</b>キーを押す）して<b>インポートウィザード</b>を開きます。</li>
<li><b>データ操作</b>では<i>&lt;Origin Folder&gt;\Samples\Curve Fitting\</i>フォルダにある<b>UptakeCurve_343K.txt</b><b>ファイル</b>を選択します。<b>進む</b>ボタンを2回クリックして<b>ヘッダ行</b>ページに移動します。<b><b>ロングネーム</b></b>、<b><b>単位</b></b>、<b><b>コメント</b></b>を順に<b><b>3</b></b>、<b><b>4</b></b>、<b><b>1から1</b></b>と設定します。 
<dl><dd><a  class="image"><img alt="Tutorial LT Para Init 02.png" src="../images/Using_Values_in_Worksheet_as_Initialized_Parameters/Tutorial_LT_Para_Init_02.png" width="741"  /></a></dd></dl></li>
<li><b>完了</b>ボタンをクリックして、ファイルをインポートします。実験温度はコメントの2列目に入力されました。これが<b>UptakeCurveFit</b>フィット関数で初期化コードLabTalkスクリプトを実行する時に取得するものです。 
<dl><dd><a  class="image"><img alt="Tutorial LT Para Init 03.png" src="../images/Using_Values_in_Worksheet_as_Initialized_Parameters/Tutorial_LT_Para_Init_03.png" width="346"  /></a></dd></dl></li>
<li>列Bを選択して<b><b>解析:フィット:非線形曲線フィット</b></b>を選択(または、<b><b>Ctrl</b>+<b>Y</b></b>を押す)して<b><b>NLFit</b></b>ダイアログを開きます。<b><b>カテゴリー</b></b>で<b>User Defined</b>を選択し、<b><b>関数</b></b>では<b>UptakeCurveFit(User)</b>を選択します。 </li>
<li>注目ダイアログがポップアップし、実験温度と計算された時間定数を表示します。
<dl><dd><a  class="image"><img alt="Tutorial LT Para Int 05.png" src="../images/Using_Values_in_Worksheet_as_Initialized_Parameters/Tutorial_LT_Para_Int_05.png" width="482"  /></a> </dd></dl></li>
<li><b><b>パラメータ</b></b>タブに移動し、パラメータTの値が5106であれば、パラメータ初期化スクリプトが正常に呼び出せたことになります。</li>
<li><b>コード</b>タブを開き、<b>パラメータ初期化</b>セクションを開くと、ここでパラメータ初期化スクリプトを再度確認でき、値は<a  class="image"><img alt="Button Initialize Parameters.png" src="../images/Using_Values_in_Worksheet_as_Initialized_Parameters/Button_Initialize_Parameters.png" width="26"  /></a>ボタンをクリックすると表示できます。 </li>
<li><b>OK</b>をクリックして注目ダイアログを閉じ、<b>フィット</b>をクリックしてフィットを実行します。</li></ol>
<h3><a name="Create_an_Analysis_Template_and_Do_Batch_Processing"></a><span class="mw-headline">分析テンプレートを作成してバッチ処理を行う</span></h3>
<ol><li>先程のステップで作成された<b>FitNL1</b>の結果シートに行きます。<b>概要</b>表の右にある三角形ボタンをクリックして<b>新しいシートとしてコピーを作成</b>を選択します。新しいシートが作成され、新しいシートの列Aを削除して名前を<b>Result</b>とします。
<dl><dd><a  class="image"><img alt="Tutorial LT Para Init 06.png" src="../images/Using_Values_in_Worksheet_as_Initialized_Parameters/Tutorial_LT_Para_Init_06.png" width="535"  /></a></dd></dl></li>
<li>ワークブックをアクティブにしたまま、<b><b>ファイル:ワークシートを分析テンプレートとして保存</b></b>をクリックしてワークブックを<b>MyUptakeFit.ogw</b>として保存します。</li>
<li>新しいプロジェクトを作成し、メニューから<b>ファイル：バッチ処理</b>と選択して<b>batchProcess</b>ダイアログを開きます。</li>
<li>分析テンプレート<b>MyUptakeFit.ogw</b>をロードし、<i>&lt;Origin Folder&gt;\Samples\Curve Fitting\</i>内にある<b>UptakeCurve_343K.txt</b>、<b>UptakeCurve_373K.txt</b>、<b>UptakeCurve_403K.txt</b>を選択します。<b>データセット識別子</b>では<b>ファイル名</b>を選択し、他の設定も下図と同じ状態である事を確認してください。
<dl><dd><a  class="image"><img alt="Tutorial LT Para Init 07.png" src="../images/Using_Values_in_Worksheet_as_Initialized_Parameters/Tutorial_LT_Para_Init_07.png" width="698"  /></a></dd></dl></li>
<li><b><b>OK</b></b>をクリックしてバッチ処理を実行します。実行される各ファイルに注目ボックスがポップアップされ、初期値として使用される値が表示されます。ポップアップされるたびに<b><b>OK</b></b>ボタンをクリックしてバッチ処理を続けます。下記のようなレポートが表示されます。
<dl><dd><a  class="image"><img alt="Tutorial LT Para Init 08.png" src="../images/Using_Values_in_Worksheet_as_Initialized_Parameters/Tutorial_LT_Para_Init_08.png" width="706"  /></a></dd></dl></li></ol>




    