<h1 class="firstHeading">4.2.2.11 Fitting with NAG Special Function</h1><p class='urlname' style='display: none'>Fitting-Special-NAG</p>
<p><br />
</p>
<div id="toc" class="toc"><div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Summary"><span class="tocnumber">1</span> <span class="toctext">Summary</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="#What_you_will_learn"><span class="tocnumber">2</span> <span class="toctext">What you will learn</span></a></li>
<li class="toclevel-1 tocsection-3"><a href="#Example_and_Steps"><span class="tocnumber">3</span> <span class="toctext">Example and Steps</span></a>
<ul>
<li class="toclevel-2 tocsection-4"><a href="#Simulate_the_Function"><span class="tocnumber">3.1</span> <span class="toctext">Simulate the Function</span></a></li>
<li class="toclevel-2 tocsection-5"><a href="#Set_the_Initial_Values_for_the_Parameters"><span class="tocnumber">3.2</span> <span class="toctext">Set the Initial Values for the Parameters</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-6"><a href="#Sample_Data"><span class="tocnumber">4</span> <span class="toctext">Sample Data</span></a></li>
</ul>
</div>

<h2><a name="Summary"></a><span class="mw-headline">Summary</span></h2>
<p>Origin allows user to define an Origin C fitting function using NAG special functions. You can call NAG routine to evaluate the special function.
</p>
<p class="version" >Minimum Origin Version Required: Origin 8.0 SR6</p>
<h2><a name="What_you_will_learn"></a><span class="mw-headline">What you will learn</span></h2>
<p>This tutorial will show you how to:
</p>
<ul><li>Create fitting function using Fitting Function Organizer</li>
<li>Create fitting function using NAG special function</li></ul>
<h2><a name="Example_and_Steps"></a><span class="mw-headline">Example and Steps</span></h2>
<p>We will fit the following model:
</p>
<dl><dd><img src="../images/Fitting_with_NAG_Special_Function/math-ce5b4588b18ccc8d106cebea09971c3a.png?v=0" title=" inorm=  A* exp(-td/2.0/(t-t0)) * ( I0(td/2.0/(t-t0))+I1(td/2.0/(t-t0)) ) \," alt=" inorm=  A* exp(-td/2.0/(t-t0)) * ( I0(td/2.0/(t-t0))+I1(td/2.0/(t-t0)) ) \," class="tex"/></dd></dl>
<p>Here <img src="../images/Fitting_with_NAG_Special_Function/math-7fc56270e7a70fa81a5935b72eacbe29.png?v=0" title="A" alt="A" class="tex"/>, <img src="../images/Fitting_with_NAG_Special_Function/math-626726e60bd1215f36719a308a25b798.png?v=0" title="td" alt="td" class="tex"/> and <img src="../images/Fitting_with_NAG_Special_Function/math-809d4580aaed41565abc38d58f77f840.png?v=0" title="t0" alt="t0" class="tex"/> are the model parameters we want to obtain from the data fitting. <img src="../images/Fitting_with_NAG_Special_Function/math-f83ba497477f1b653cb3af0bcd5bd7f9.png?v=0" title="I0" alt="I0" class="tex"/> and <img src="../images/Fitting_with_NAG_Special_Function/math-a18c217c4f2a811afcaaf5052945e31b.png?v=0" title="I1" alt="I1" class="tex"/> are the first kind of Modified Bessel function of order 0 and order 1, respectively. For current example, we use the sample data in the end of this tutorial. The fitting procedure can be outlined into the following steps:
</p><p>Press <b>F9</b> to open the <span class="db">Fitting Function Organizer</span> and then create a new Category named <b><i>FittingWithNAGSpecialFunc</i></b>. Define a new fitting function <b><i>FittingWithBessel</i></b> in the new category as follow: 
</p>
<table class="simple">

<tr>
<td width="150"> <b>Function Name:</b>
</td>
<td> FittingWithBessel
</td></tr>
<tr>
<td> <b>Function Type:</b>
</td>
<td> User-Defined
</td></tr>
<tr>
<td> <b>Independent Variables:</b>
</td>
<td> t
</td></tr>
<tr>
<td> <b>Dependent Variables:</b>
</td>
<td> inorm
</td></tr>
<tr>
<td> <b>Parameter Names:</b>
</td>
<td> A,t0,td
</td></tr>
<tr>
<td> <b>Function Form:</b>
</td>
<td> <font color="blue">Origin C</font>
</td></tr>
<tr>
<td> <b>Function:</b>
</td>
<td>
</td></tr></table>
<p>Click the button (icon) beside the <b>Function</b> box to open the code builder and define and compile and save the fitting function as follows:
</p>
<pre class="oc" style="font-family:monospace;"><span style="color: #0000ff;">#include</span> <span style="color: #000080;">&lt;</span>origin.<span style="color: #000000;">h</span><span style="color: #000080;">&gt;</span>

<span style="color: #008000;">// Add your special include files here.</span>
<span style="color: #008000;">// For example, if you want to fit with functions from the NAG library, </span>
<span style="color: #008000;">// add the header file for the NAG functions here.</span>
<span style="color: #0000ff;">#include</span> <span style="color: #000080;">&lt;</span>OC_nag8.<span style="color: #000000;">h</span><span style="color: #000080;">&gt;</span>

<span style="color: #008000;">// Add code here for other Origin C functions that you want to define in this file,</span>
<span style="color: #008000;">// and access in your fitting function.</span>

<span style="color: #008000;">// You can access C functions defined in other files, if those files are loaded and compiled </span>
<span style="color: #008000;">// in your workspace, and the functions have been prototyped in a header file that you have</span>
<span style="color: #008000;">// included above. </span>

<span style="color: #008000;">// You can access NLSF object methods and properties directly in your function code.</span>

<span style="color: #008000;">// You should follow C-language syntax in defining your function. </span>
<span style="color: #008000;">// For instance, if your parameter name is P1, you cannot use p1 in your function code. </span>
<span style="color: #008000;">// When using fractions, remember that integer division such as 1/2 is equal to 0, and not 0.5</span>
<span style="color: #008000;">// Use 0.5 or 1/2.0 to get the correct value.</span>

<span style="color: #008000;">// For more information and examples, please refer to the &quot;User-Defined Fitting Function&quot; </span>
<span style="color: #008000;">// section of the Origin Help file.</span>


<span style="color: #008000;">//----------------------------------------------------------</span>
<span style="color: #008000;">// </span>
<span style="color: #0000ff;">void</span> _nlsfFittingWithBessel<span style="color: #000000;">&#40;</span>
<span style="color: #008000;">// Fit Parameter(s):</span>
<span style="color: #0000ff;">double</span> A, <span style="color: #0000ff;">double</span> t0, <span style="color: #0000ff;">double</span> td,
<span style="color: #008000;">// Independent Variable(s):</span>
<span style="color: #0000ff;">double</span> t,
<span style="color: #008000;">// Dependent Variable(s):</span>
<span style="color: #0000ff;">double</span><span style="color: #000040;">&amp;</span> inorm<span style="color: #000000;">&#41;</span>
<span style="color: #000000;">&#123;</span>
	<span style="color: #008000;">// Beginning of editable part</span>
	<span style="color: #008000;">//inorm=  A* exp(-td/2.0/(t-t0)) *   ( s18aec(td/2.0/(t-t0),NAGERR_DEFAULT)+s18afc(td/2.0/(t-t0),NAGERR_DEFAULT) );</span>
	
	<span style="color: #0000ff;">static</span> NagError fail1; 
	<span style="color: #0000ff;">static</span> NagError fail2;
	<span style="color: #0000ff;">double</span> dtemp <span style="color: #000080;">=</span> td<span style="color: #000040;">/</span><span style="color: #0000dd;">2.0</span><span style="color: #000040;">/</span><span style="color: #000000;">&#40;</span>t<span style="color: #000040;">-</span>t0<span style="color: #000000;">&#41;</span>;
	inorm<span style="color: #000080;">=</span>  A<span style="color: #000040;">*</span> <span style="color: #000000;">exp</span><span style="color: #000000;">&#40;</span><span style="color: #000040;">-</span>dtemp<span style="color: #000000;">&#41;</span> <span style="color: #000040;">*</span> <span style="color: #000000;">&#40;</span> s18aec<span style="color: #000000;">&#40;</span>dtemp,<span style="color: #000040;">&amp;</span>fail1<span style="color: #000000;">&#41;</span><span style="color: #000040;">+</span>s18afc<span style="color: #000000;">&#40;</span>dtemp,<span style="color: #000040;">&amp;</span>fail2<span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#41;</span>;
	<span style="color: #0000ff;">if</span><span style="color: #000000;">&#40;</span>fail1.<span style="color: #000000;">code</span> <span style="color: #000040;">!</span><span style="color: #000080;">=</span>NE_NOERROR<span style="color: #000000;">&#41;</span>
		<span style="color: #000000;">printf</span><span style="color: #000000;">&#40;</span><span style="color: #ff00ff;">&quot;%s<span style="color: #666666; font-weight: bold;">\n</span>&quot;</span>,fail1.<span style="color: #000000;">message</span><span style="color: #000000;">&#41;</span>;
	<span style="color: #0000ff;">if</span><span style="color: #000000;">&#40;</span>fail2.<span style="color: #000000;">code</span> <span style="color: #000040;">!</span><span style="color: #000080;">=</span>NE_NOERROR<span style="color: #000000;">&#41;</span>
		<span style="color: #000000;">printf</span><span style="color: #000000;">&#40;</span><span style="color: #ff00ff;">&quot;%s<span style="color: #666666; font-weight: bold;">\n</span>&quot;</span>,fail2.<span style="color: #000000;">message</span><span style="color: #000000;">&#41;</span>;
	
	
	<span style="color: #008000;">// End of editable part</span>
<span style="color: #000000;">&#125;</span></pre>
<p><br />
</p>
<h3><a name="Simulate_the_Function"></a><span class="mw-headline">Simulate the Function</span></h3>
<p>After the function body is defined, you can click the <b>Compile</b> button in <b>Code Builder</b> to check syntax errors. And then click <b>Return to Dialog</b> button to go back <span class="db">Fitting Function Organizer</span> dialog box. Now click the <b>Save</b> button to generate the .FDF file (Function definition file). 
</p><p>Once you have a .FDF file, you can click the <b>Simulate</b> button to simulate a curve, this will be very helpful to evaluate the initial values. In the <b>simcurve</b> dialog, enter some proper parameter values and X range, and see what the curve looks like in the <b>Preview</b> panel.
</p>
<h3><a name="Set_the_Initial_Values_for_the_Parameters"></a><span class="mw-headline">Set the Initial Values for the Parameters</span></h3>
<p>As it is a user-defined fitting function, you have to supply the initial guess values for the parameters before performing your fitting task for the data. You may do it by set them manually in the <b>Parameter</b> tab in <b>Nonlinear Curve Fit</b> dialog. For the sample data shown below, you can just set the initial values for the parameters A = 1, td = 1, t0 = 1. After the parameters are initialized, you can then do the fitting to obtain the fitting result, as shown to the right of the sample data.
</p>
<h2><a name="Sample_Data"></a><span class="mw-headline">Sample Data</span></h2>
<p>Copy the below sample data and use <b>Import Wizard</b> to import the data from <b>Clipboard</b>, then do the fitting using the given initial values for the parameters: A = 1, td = 1, t0 = 1. 
</p>
<dl><dd><table class="simple" style="width:480px">

<tr>
<th colspan="2" align="center">Sample Data
</th>
<th>Results
</th></tr>
<tr>
<td> <b>X</b>
</td>
<td> <b>Y</b>
</td>
<td rowspan="11"><a  class="image"><img alt="FittingWithBessel.PNG" src="../images/Fitting_with_NAG_Special_Function/FittingWithBessel.PNG?v=3294" width="224"  /></a>
</td></tr>
<tr>
<td> 2
</td>
<td> 0.7868954118
</td></tr>
<tr>
<td> 2.080808081
</td>
<td> 0.8133022141
</td></tr>
<tr>
<td> 2.161616162
</td>
<td> 0.8178216765
</td></tr>
<tr>
<td> 2.242424242
</td>
<td> 0.8427866729
</td></tr>
<tr>
<td> 2.323232323
</td>
<td> 0.8315815363
</td></tr>
<tr>
<td> 2.404040404
</td>
<td> 0.8484657180
</td></tr>
<tr>
<td> 2.565656566
</td>
<td> 0.8618233553
</td></tr>
<tr>
<td> 2.646464646
</td>
<td> 0.8745962570
</td></tr>
<tr>
<td> 2.727272727
</td>
<td> 0.8921620316
</td></tr>
<tr>
<td> 2.808080808
</td>
<td> 0.8687399759
</td></tr></table></dd></dl>






