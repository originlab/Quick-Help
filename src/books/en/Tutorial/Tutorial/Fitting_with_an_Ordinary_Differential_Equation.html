<h1 class="firstHeading">4.2.2.26 Fitting with an Ordinary Differential Equation</h1><p class='urlname' style='display: none'>Fitting-Ordinary-Differential-Equation</p>
<p><br />
</p>
<div id="toc" class="toc"><div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Summary"><span class="tocnumber">1</span> <span class="toctext">Summary</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="#What_you_will_learn"><span class="tocnumber">2</span> <span class="toctext">What you will learn</span></a></li>
<li class="toclevel-1 tocsection-3"><a href="#Example_and_Steps"><span class="tocnumber">3</span> <span class="toctext">Example and Steps</span></a>
<ul>
<li class="toclevel-2 tocsection-4"><a href="#Import_Data"><span class="tocnumber">3.1</span> <span class="toctext">Import Data</span></a></li>
<li class="toclevel-2 tocsection-5"><a href="#Define_Fitting_Function"><span class="tocnumber">3.2</span> <span class="toctext">Define Fitting Function</span></a></li>
<li class="toclevel-2 tocsection-6"><a href="#Fit_the_Curve"><span class="tocnumber">3.3</span> <span class="toctext">Fit the Curve</span></a></li>
<li class="toclevel-2 tocsection-7"><a href="#Fitting_Results"><span class="tocnumber">3.4</span> <span class="toctext">Fitting Results</span></a></li>
</ul>
</li>
</ul>
</div>

<p><br />
</p>
<table class="simple" style="width: 80%">

<tr style="vertical-align: top;">
<td style="width: 40%"><a  class="image"><img alt="Video Image.png" src="../images/Fitting_with_an_Ordinary_Differential_Equation/Video_Image.png?v=58041" width="33"  /></a> <a  class="image"><img alt="Video Text Image.png" src="../images/Fitting_with_an_Ordinary_Differential_Equation/Video_Text_Image.png?v=64565" width="135"  /></a>
<ul><li> <a class="external text" href="https://www.originlab.com/videos/details.aspx?id=60" target="_blank">User-defined Fitting Functions</a></li></ul>
</td>
<td style="width: 40%"><a  class="image"><img alt="Website blog icon circle.png" src="../images/Fitting_with_an_Ordinary_Differential_Equation/Website_blog_icon_circle.png?v=64566" width="31"  /></a> <a  class="image"><img alt="Blog Image 33x33px.png" src="../images/Fitting_with_an_Ordinary_Differential_Equation/Blog_Image_33x33px.png?v=64564" width="135"  /></a>
</td></tr></table>
<h2><a name="Summary"></a><span class="mw-headline">Summary</span></h2>
<p>In this tutorial we will show you how to define an ordinary differential equation (<b>ODE</b>) in the <b>Fitting function Builder</b> dialog and perform a fit of the data using this fitting function.
</p>
<p class="version" >Minimum Origin Version Required: Origin 9.1 SR0</p>
<h2><a name="What_you_will_learn"></a><span class="mw-headline">What you will learn</span></h2>
<p>This tutorial will show you how to: 
</p>
<ul><li> Define an ODE fitting function.</li>
<li> Call NAG functions using Origin C code.</li>
<li> Recalculate the ODE result only when parameters are updated.</li>
<li> Interpolate on the ODE result.</li></ul>
<h2><a name="Example_and_Steps"></a><span class="mw-headline">Example and Steps</span></h2>
<p>In this tutorial, we will use a first order ordinary differential equation as an example: 
</p>
<dl><dd><img src="../images/Fitting_with_an_Ordinary_Differential_Equation/math-3139ba5ac00c6da70c79240db577d5af.png?v=0" title="\frac{\mathrm{d} y}{\mathrm{d} x}=ay" alt="\frac{\mathrm{d} y}{\mathrm{d} x}=ay" class="tex"/></dd>
<dd><img src="../images/Fitting_with_an_Ordinary_Differential_Equation/math-fa0aad52f07a3069cc4b0a22552679b3.png?v=0" title="y|_{x=x0}=y0" alt="y|_{x=x0}=y0" class="tex"/></dd></dl>
<p>where <b>a</b> is a parameter in the ordinary differential equation and  <b>y0</b> is the initial value for the ODE. NAG functions <b>d02pvc</b> and <b>d02pcc</b> are called using the Rungeâ€“Kutta method to solve the <b>ODE</b> problem. 
</p>
<h3><a name="Import_Data"></a><span class="mw-headline">Import Data</span></h3>
<ol><li> Start with an empty workbook. Select <b>Help: Open Folder: Sample Folder...</b> to open the "Samples" folder. In this folder, open the <i>Curve Fitting</i> subfolder and find the file <i>Exponential Growth.dat</i>. Drag-and-drop this file into the empty worksheet to import it.</li>
<li> Highlight <b>B</b> column, and select <b>Plot: Symbol: Scatter</b> from Origin menu. The graph should look like:
<dl><dd><a  class="image"><img alt="Fit ODEex.jpg" src="../images/Fitting_with_an_Ordinary_Differential_Equation/Fit_ODEex.jpg?v=24213" width="503"  /></a></dd></dl></li></ol>
<h3><a name="Define_Fitting_Function"></a><span class="mw-headline">Define Fitting Function</span></h3>
<p>The fitting function can be defined using the <b>Fitting Function Builder</b> tool.
</p>
<ol>
<li> Select <b>Tools: Fitting Function Builder</b> from Origin menu.
<li> On the <b>Fitting Function Builder</b> dialog's <b>Goal</b> page, ensure the <b>Create New Function</b> radio button is selected. Click the <b>Next</b> button.
<li> On the <b>Name and Type</b> page, From the <b>Select or create a Category</b> drop-down list select <b>User Defined</b>. For <b>Function Name</b> type <b>FitODE</b>. In the <b>Function Type</b> section select the <b>Origin C</b> radio button. Click <b>Next</b>.
<li> On the <b>Variables and Parameters</b> page, in the <b>Parameters</b> field type <b>a, y0</b>. Click <b>Next</b>.
<li> On the <b>Origin C Fitting Function</b> page, click the <a  class="image"><img alt="User-Defined Fitting Functions-2.png" src="../images/Fitting_with_an_Ordinary_Differential_Equation/User-Defined_Fitting_Functions-2.png?v=4571" width="19"  /></a> button on the right of the <b>Function Body</b> edit box and define the function in <b>Code Builder</b> as follows.

Include header files for NAG and fitting: 
<pre class="oc" style="font-family:monospace;"><span style="color: #0000ff;">#include</span> <span style="color: #000080;">&lt;</span>oc_nag.<span style="color: #000000;">h</span><span style="color: #000080;">&gt;</span>
<span style="color: #0000ff;">#include</span> <span style="color: #000080;">&lt;</span>ONLSF.<span style="color: #000000;">H</span><span style="color: #000080;">&gt;</span></pre>
<p>Define a static function to solve ODE by calling NAG functions. Call NAG function <b>d02pvc</b> to establish ODE model and <b>d02pcc</b> to solve the model:
</p>
<pre class="oc" style="font-family:monospace;"><span style="color: #0000ff;">struct</span> user   <span style="color: #008000;">// parameter in the ODE</span>
<span style="color: #000000;">&#123;</span>
	<span style="color: #0000ff;">double</span> a;
<span style="color: #000000;">&#125;</span>;

<span style="color: #008000;">//Define the differentiate equation: y'=a*y</span>
<span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> NAG_CALL f<span style="color: #000000;">&#40;</span><span style="color: #0000ff;">double</span> t, Integer neq, <span style="color: #0000ff;">const</span> <span style="color: #0000ff;">double</span> <span style="color: #000040;">*</span>y, <span style="color: #0000ff;">double</span> <span style="color: #000040;">*</span>yp, Nag_Comm <span style="color: #000040;">*</span>comm<span style="color: #000000;">&#41;</span>
<span style="color: #000000;">&#123;</span>
	neq; <span style="color: #008000;">//Number of ordinary differential equations</span>
	t; <span style="color: #008000;">//Independent variable</span>
	y; <span style="color: #008000;">//Dependent variables</span>
	yp; <span style="color: #008000;">//First derivative</span>

	<span style="color: #0000ff;">struct</span> user <span style="color: #000040;">*</span>sp <span style="color: #000080;">=</span> <span style="color: #000000;">&#40;</span><span style="color: #0000ff;">struct</span> user <span style="color: #000040;">*</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#40;</span>comm<span style="color: #000040;">-</span><span style="color: #000080;">&gt;</span>p<span style="color: #000000;">&#41;</span>;
	<span style="color: #0000ff;">double</span> a;
	a <span style="color: #000080;">=</span> sp<span style="color: #000040;">-</span><span style="color: #000080;">&gt;</span>a;

	yp<span style="color: #000000;">&#91;</span><span style="color: #0000dd;">0</span><span style="color: #000000;">&#93;</span> <span style="color: #000080;">=</span> a<span style="color: #000040;">*</span>y<span style="color: #000000;">&#91;</span><span style="color: #0000dd;">0</span><span style="color: #000000;">&#93;</span>;
<span style="color: #000000;">&#125;</span>


<span style="color: #008000;">//Use Runge-Kutta ODE23 to solve ODE</span>
<span style="color: #0000ff;">static</span> <span style="color: #0000ff;">bool</span> nag_ode_fit<span style="color: #000000;">&#40;</span> <span style="color: #0000ff;">const</span> <span style="color: #0000ff;">double</span> a, <span style="color: #0000ff;">const</span> <span style="color: #0000ff;">double</span> y0, <span style="color: #0000ff;">const</span> <span style="color: #0000ff;">double</span> tstart, 
  <span style="color: #0000ff;">const</span> <span style="color: #0000ff;">double</span> tend, <span style="color: #0000ff;">const</span> <span style="color: #0000ff;">int</span> nout, vector <span style="color: #000040;">&amp;</span>vP <span style="color: #000000;">&#41;</span>
<span style="color: #000000;">&#123;</span>
	<span style="color: #008000;">//nout: Number of points to output	</span>
	<span style="color: #0000ff;">if</span><span style="color: #000000;">&#40;</span> nout <span style="color: #000080;">&lt;</span> <span style="color: #0000dd;">2</span> <span style="color: #000000;">&#41;</span>
		<span style="color: #0000ff;">return</span> <span style="color: #0000ff;">false</span>;

	vP.<span style="color: #000000;">SetSize</span><span style="color: #000000;">&#40;</span> nout <span style="color: #000000;">&#41;</span>;
	vP<span style="color: #000000;">&#91;</span><span style="color: #0000dd;">0</span><span style="color: #000000;">&#93;</span> <span style="color: #000080;">=</span> y0;

	<span style="color: #0000ff;">int</span> neq <span style="color: #000080;">=</span> <span style="color: #0000dd;">1</span>; <span style="color: #008000;">//Number of ordinary differential equations</span>
	Nag_RK_method method;

	<span style="color: #0000ff;">double</span> hstart, tgot, tinc;

	<span style="color: #0000ff;">double</span> tol, twant;
	<span style="color: #0000ff;">int</span> i, j;

	vector thres<span style="color: #000000;">&#40;</span>neq<span style="color: #000000;">&#41;</span>, ygot<span style="color: #000000;">&#40;</span>neq<span style="color: #000000;">&#41;</span>, ymax<span style="color: #000000;">&#40;</span>neq<span style="color: #000000;">&#41;</span>, ypgot<span style="color: #000000;">&#40;</span>neq<span style="color: #000000;">&#41;</span>, ystart<span style="color: #000000;">&#40;</span>neq<span style="color: #000000;">&#41;</span>;
		
	Nag_ErrorAssess errass;
	Nag_Comm comm;

	<span style="color: #0000ff;">struct</span> user s;
	s.<span style="color: #000000;">a</span> <span style="color: #000080;">=</span> a;
	comm.<span style="color: #000000;">p</span> <span style="color: #000080;">=</span> <span style="color: #000000;">&#40;</span>Pointer<span style="color: #000000;">&#41;</span><span style="color: #000040;">&amp;</span>s;
	ystart<span style="color: #000000;">&#91;</span><span style="color: #0000dd;">0</span><span style="color: #000000;">&#93;</span> <span style="color: #000080;">=</span> y0;
	<span style="color: #0000ff;">for</span> <span style="color: #000000;">&#40;</span>i<span style="color: #000080;">=</span><span style="color: #0000dd;">0</span>; i<span style="color: #000080;">&lt;</span>neq; i<span style="color: #000040;">++</span><span style="color: #000000;">&#41;</span>
		thres<span style="color: #000000;">&#91;</span>i<span style="color: #000000;">&#93;</span> <span style="color: #000080;">=</span> 1.0e<span style="color: #000040;">-</span>8;
	errass <span style="color: #000080;">=</span> Nag_ErrorAssess_off;
	hstart <span style="color: #000080;">=</span> <span style="color: #0000dd;">0</span>;
	method <span style="color: #000080;">=</span> Nag_RK_2_3;
	tinc <span style="color: #000080;">=</span> <span style="color: #000000;">&#40;</span>tend<span style="color: #000040;">-</span>tstart<span style="color: #000000;">&#41;</span><span style="color: #000040;">/</span><span style="color: #000000;">&#40;</span>nout<span style="color: #000040;">-</span><span style="color: #0000dd;">1</span><span style="color: #000000;">&#41;</span>;
	tol <span style="color: #000080;">=</span> 1.0e<span style="color: #000040;">-</span>3;

	NagError nagErr1;
	<span style="color: #008000;">//Setup ODE</span>
	<span style="color: #0000ff;">int</span> iwsav<span style="color: #000000;">&#91;</span><span style="color: #0000dd;">130</span><span style="color: #000000;">&#93;</span>;
	<span style="color: #0000ff;">double</span><span style="color: #000040;">*</span> rwsav <span style="color: #000080;">=</span> <span style="color: #000000;">&#40;</span><span style="color: #0000ff;">double</span><span style="color: #000040;">*</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">malloc</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#40;</span><span style="color: #0000dd;">350</span> <span style="color: #000040;">+</span> <span style="color: #0000dd;">32</span><span style="color: #000040;">*</span>neq<span style="color: #000000;">&#41;</span><span style="color: #000040;">*</span><span style="color: #000000;">sizeof</span><span style="color: #000000;">&#40;</span><span style="color: #0000ff;">double</span><span style="color: #000000;">&#41;</span><span style="color: #000000;">&#41;</span>;
	nag_ode_ivp_rkts_setup<span style="color: #000000;">&#40;</span>neq, tstart, tend, ystart, tol, thres, method, errass, hstart, iwsav, rwsav, <span style="color: #000040;">&amp;</span>nagErr1<span style="color: #000000;">&#41;</span>;

	<span style="color: #0000ff;">if</span><span style="color: #000000;">&#40;</span> nagErr1.<span style="color: #000000;">code</span> <span style="color: #000040;">!</span><span style="color: #000080;">=</span> NE_NOERROR <span style="color: #000000;">&#41;</span>
	<span style="color: #000000;">&#123;</span>
		<span style="color: #000000;">free</span><span style="color: #000000;">&#40;</span>rwsav<span style="color: #000000;">&#41;</span>;
		<span style="color: #0000ff;">return</span> <span style="color: #0000ff;">false</span>;
	<span style="color: #000000;">&#125;</span>

	<span style="color: #0000ff;">for</span> <span style="color: #000000;">&#40;</span>j<span style="color: #000080;">=</span><span style="color: #0000dd;">1</span>; j<span style="color: #000080;">&lt;</span>nout; j<span style="color: #000040;">++</span><span style="color: #000000;">&#41;</span>
	<span style="color: #000000;">&#123;</span>
		twant <span style="color: #000080;">=</span> tstart <span style="color: #000040;">+</span> j<span style="color: #000040;">*</span>tinc;
		NagError nagErr2;
		<span style="color: #008000;">//Solve ODE</span>
		nag_ode_ivp_rkts_range<span style="color: #000000;">&#40;</span>f, neq, twant, <span style="color: #000040;">&amp;</span>tgot, ygot, ypgot, ymax, <span style="color: #000040;">&amp;</span>comm, iwsav, rwsav, <span style="color: #000040;">&amp;</span>nagErr2<span style="color: #000000;">&#41;</span>;
			
		<span style="color: #0000ff;">if</span><span style="color: #000000;">&#40;</span> nagErr2.<span style="color: #000000;">code</span> <span style="color: #000040;">!</span><span style="color: #000080;">=</span> NE_NOERROR <span style="color: #000000;">&#41;</span>
		<span style="color: #000000;">&#123;</span>
			<span style="color: #000000;">free</span><span style="color: #000000;">&#40;</span>rwsav<span style="color: #000000;">&#41;</span>;
			<span style="color: #0000ff;">return</span> <span style="color: #0000ff;">false</span>;
		<span style="color: #000000;">&#125;</span>
			
		vP<span style="color: #000000;">&#91;</span>j<span style="color: #000000;">&#93;</span> <span style="color: #000080;">=</span> ygot<span style="color: #000000;">&#91;</span><span style="color: #0000dd;">0</span><span style="color: #000000;">&#93;</span>;
	<span style="color: #000000;">&#125;</span>

	<span style="color: #000000;">free</span><span style="color: #000000;">&#40;</span>rwsav<span style="color: #000000;">&#41;</span>;
	<span style="color: #0000ff;">return</span> <span style="color: #0000ff;">true</span>;
<span style="color: #000000;">&#125;</span></pre>
<p>Define the fitting function body <b>_nlsfFitODE</b>:
</p>
<pre class="oc" style="font-family:monospace;">NLFitContext <span style="color: #000040;">*</span>pCtxt <span style="color: #000080;">=</span> Project.<span style="color: #000000;">GetNLFitContext</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;
<span style="color: #0000ff;">if</span> <span style="color: #000000;">&#40;</span> pCtxt <span style="color: #000000;">&#41;</span>
<span style="color: #000000;">&#123;</span>
  <span style="color: #0000ff;">static</span> vector vX, vY;
  <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">int</span> nSize;

  <span style="color: #0000ff;">BOOL</span> bIsNewParamValues <span style="color: #000080;">=</span> pCtxt<span style="color: #000040;">-</span><span style="color: #000080;">&gt;</span>IsNewParamValues<span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;
  <span style="color: #008000;">// If parameters were updated, we will recalculate the ODE result.</span>
  <span style="color: #0000ff;">if</span> <span style="color: #000000;">&#40;</span> bIsNewParamValues <span style="color: #000000;">&#41;</span>
  <span style="color: #000000;">&#123;</span>
    <span style="color: #008000;">//Initial and final values of the independent variable</span>
    <span style="color: #0000ff;">double</span> tstart <span style="color: #000080;">=</span> <span style="color: #0000dd;">0.02</span>, tend <span style="color: #000080;">=</span> <span style="color: #0000dd;">2</span>, tinc;
    <span style="color: #0000ff;">int</span> nout <span style="color: #000080;">=</span> <span style="color: #0000dd;">100</span>; <span style="color: #008000;">//Number of points</span>
		
    tinc <span style="color: #000080;">=</span> <span style="color: #000000;">&#40;</span>tend<span style="color: #000040;">-</span>tstart<span style="color: #000000;">&#41;</span><span style="color: #000040;">/</span><span style="color: #000000;">&#40;</span>nout<span style="color: #000040;">-</span><span style="color: #0000dd;">1</span><span style="color: #000000;">&#41;</span>;
    vX.<span style="color: #000000;">Data</span><span style="color: #000000;">&#40;</span> tstart, tend, tinc <span style="color: #000000;">&#41;</span>;
    nSize <span style="color: #000080;">=</span> vX.<span style="color: #000000;">GetSize</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span>;
		
    <span style="color: #0000ff;">if</span><span style="color: #000000;">&#40;</span> <span style="color: #000040;">!</span>nag_ode_fit<span style="color: #000000;">&#40;</span> a, y0, tstart, tend, nout, vY<span style="color: #000000;">&#41;</span> <span style="color: #000000;">&#41;</span>
      <span style="color: #0000ff;">return</span>;
  <span style="color: #000000;">&#125;</span>
	
  <span style="color: #008000;">//Interpolate y from fitting data's x on the ODE result.</span>
  ocmath_interpolate<span style="color: #000000;">&#40;</span> <span style="color: #000040;">&amp;</span>x, <span style="color: #000040;">&amp;</span>y, <span style="color: #0000dd;">1</span>, vX, vY, nSize <span style="color: #000000;">&#41;</span>;
<span style="color: #000000;">&#125;</span></pre>
<p>Click the <b>Compile</b> button to compile the function body. To return, click <b>Return to Dialog</b> button. The <b>Evaluate</b> button on the dialog has a black figure of a running person.  Clicking on it will show y=2.6627270424371. This implies that the function works. Click <b>Next</b>.
</p>
<li>In the <b>Parameter Initialization Code</b> page, select <b>Use Custom Code</b> radio button, and type the code in the <b>Initialization Code</b> box:
<pre class="oc" style="font-family:monospace;"><span style="color: #008000;">//Set the start y value in fitting data as the initial value of y0</span>
y0 <span style="color: #000080;">=</span> y_data<span style="color: #000000;">&#91;</span><span style="color: #0000dd;">0</span><span style="color: #000000;">&#93;</span>;
a <span style="color: #000080;">=</span> <span style="color: #0000dd;">1</span>;</pre>
<p>and click <b>Finish</b>.
</p>
</ol>
<p><br />
</p>
<table class="note">

<tr>
<td><b>Note:</b> In order to monitor the the fitted parameters, <a class="external text" href="../../OriginC/Category/NLFitContext_(class).html">NLFitContext class</a> was introduced in defining fitting function to achieve some key information within the fitter
</td></tr></table>
<h3><a name="Fit_the_Curve"></a><span class="mw-headline">Fit the Curve</span></h3>
<ol>
<li> Highlight <b>B</b> column, then select <b>Analysis: Fitting: Nonlinear Curve Fit</b> from Origin menu. In the <b>NLFit</b> dialog, select <b>Settings: Function Selection</b>, in the page select <b>User Defined</b> from the <b>Category</b> drop-down list and <b>FitODE</b> function from the <b>Function</b> drop-down list.
<li> Select <b>Parameters</b> tab, and fix <b>y0</b> as shown in the dialog.
<dl><dt><dl><dd><a  class="image"><img alt="Fit ODE FitP.jpg" src="../images/Fitting_with_an_Ordinary_Differential_Equation/Fit_ODE_FitP.jpg?v=24261" width="422"  /></a></dt></dl></dd></dl>
<li> Click <b>Fit</b> button to fit the curve.
</ol>
<h3><a name="Fitting_Results"></a><span class="mw-headline">Fitting Results</span></h3>
<p>The fitted curve should resemble the following image:
</p>
<dl><dt><dl><dd><a  class="image"><img alt="Fit ODE Curve.png" src="../images/Fitting_with_an_Ordinary_Differential_Equation/Fit_ODE_Curve.png?v=24258" width="423"  /></a></dt></dl></dd></dl>
<p>Fitted Parameters will be shown as in the following table:
</p>
<table class="simple">
<tr>
<th><b>Parameter</b>
</th>
<th><b>Value</b>
</th>
<th><b>Standard Error</b>
</th></tr>
<tr>
<th><b>a</b>
</th>
<td> 1.30272
</td>
<td> 0.00858
</td></tr>
<tr>
<th><b>y0</b>
</th>
<td> 0.77038
</td>
<td> 0
</td></tr></table>
<p><br />
<b>Note</b>: Fitting with more complex ODE fitting functions can also be done in a similar way.
</p>





