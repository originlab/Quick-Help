<h1 class="firstHeading">2.51 Neural Network Regression (Pro)</h1><p class='urlname' style='display: none'>Neural-Network-Regression</p>
<div class="toclimit-2"><div id="toc" class="toc"><div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Summary"><span class="tocnumber">1</span> <span class="toctext">Summary</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="#Sample_OPJ"><span class="tocnumber">2</span> <span class="toctext">Sample OPJ</span></a></li>
<li class="toclevel-1 tocsection-3"><a href="#Example_1:_Two-Peaks_Curve_Fitting"><span class="tocnumber">3</span> <span class="toctext">Example 1: Two-Peaks Curve Fitting</span></a></li>
<li class="toclevel-1 tocsection-4"><a href="#Example_2:_Multiple_Linear_Regression"><span class="tocnumber">4</span> <span class="toctext">Example 2: Multiple Linear Regression</span></a>
<ul>
<li class="toclevel-2 tocsection-5"><a href="#Using_Results_in_Python_from_the_Trained_Model"><span class="tocnumber">4.1</span> <span class="toctext">Using Results in Python from the Trained Model</span></a></li>
</ul>
</li>
</ul>
</div>
</div>
<h2><a name="Summary"></a><span class="mw-headline">Summary</span></h2>
<p>This <a class="external text" href="https://www.originlab.com/fileExchange/details.aspx?fid=581" target="_blank">Neural Network Regression app</a> is used to fit data with neural network backpropagation. It trains a neural network to map between a set of inputs and output. The app can be used to predict response of independent variables.
</p>
<table class="noborder"><tr>
	<td style="vertical-align:top" width="60"><img src="../images/Neural_Network_Regression/Tip_icon.png?v=8477" width="57"  border="0" /></td><td><p><b>Required Python library for the app</b>
</p>
<ul><li>  scikit-learn</li></ul>
<p><b>Other dependent Python libraries</b>
</p>
<table class="tbl">

<tr>
<td> joblib
</td>
<td> threadpoolctl
</td>
<td> numpy
</td>
<td> scipy
</td></tr></table>
<p>The required library and other dependent Python libraries will be automatically installed when the App is launched the time.
</p></td></tr></table>
<table class="noborder"><tr>
	<td style="vertical-align:top" width="60"><img src="../images/Neural_Network_Regression/Tip_icon.png?v=8477" width="57"  border="0" /></td><td><p>Origin provides another app <a class="external text" href="https://www.originlab.com/fileExchange/details.aspx?fid=540" target="_blank"><b>Neural Network Fitting</b></a> to do the same work with <b>R</b> packages.
</p></td></tr></table>
<p><br />
</p>
<h2><a name="Sample_OPJ"></a><span class="mw-headline">Sample OPJ</span></h2>
<ol><li> Right click on the app in Apps Gallery and choose <b>Show Samples Folder</b> from the context menu
<dl><dd><a  class="image"><img alt="NNR sample.png" src="../images/Neural_Network_Regression/180px-NNR_sample.png?v=70362" width="180"   /></a></dd></dl></li>
<li> Drag and drop the project file in the opened folder to Origin to open it</li></ol>
<h2><a name="Example_1:_Two-Peaks_Curve_Fitting"></a><span class="mw-headline">Example 1: Two-Peaks Curve Fitting</span></h2>
<p>We have a curve with two peaks, and want to fit it with network backpropagation. We will then predict Y values from given X values.
</p>
<dl><dd><a  class="image"><img alt="Two peaks.png" src="../images/Neural_Network_Regression/600px-Two_peaks.png?v=70336" width="600"   /></a></dd></dl>
<table class="noborder"><tr>
	<td style="vertical-align:top" width="60"><img src="../images/Neural_Network_Regression/Tip_icon.png?v=8477" width="57"  border="0" /></td><td><p>There is no fixed way for finding the best settings of the model. The settings often require several attempts based on your data, to optimize the results. 
</p></td></tr></table>
<ol><li> Make sure we opened folder <b>1. Two Peaks</b></li>
<li> Create a scatter plot graph from column A and B of Book5. Activate the graph and click on the <b>Neural Network Regression</b> icon in the <b>Apps Gallery</b> to open the dialog</li>
<li> <b>Input</b> is filled automatically with the 1st plot on graph</li>
<li> In the <b>Options</b> tab, change the settings as below. and click <b>OK</b> button
<dl><dd> <a  class="image"><img alt="Two peaks nnr setting.png" src="../images/Neural_Network_Regression/400px-Two_peaks_nnr_setting.png?v=70340" width="400"   /></a></dd></dl>
<ul><li> "4 8 7 4" is the number of neurons in each hidden layer. (The selection of an architecture for your neural network can only be done by trial and error. You can refer to <a class="external text" href="https://stats.stackexchange.com/questions/181/how-to-choose-the-number-of-hidden-layers-and-nodes-in-a-feedforward-neural-netw" target="_blank">the reference page</a> as a starting point.)</li>
<li> <b>Hyperbolic Tangent</b> is chosen as Activation Function because we are going to fit a nonlinear curve. Both <b>Hyperbolic Tangent</b> and <b>Logistic</b> are good for nonlinear curve with peaks. </li>
<li> <b>Standardize Independent Variables</b> is set to be <b>None</b>. If the variables are measured in different scales, you can standardize variables. We do not need that for the present data.</li></ul></li>
<li> A new book with Neural Network Regression result is generated
<dl><dd><a  class="image"><img alt="NNR two peaks results.png" src="../images/Neural_Network_Regression/600px-NNR_two_peaks_results.png?v=70345" width="600"   /></a></dd></dl></li>
<li> Now we are going to predict Y from given X values. Click the green lock on the report sheet and choose <b>Change Parameters</b> from the menu. </li>
<li> In the <b>Prediction</b> tab of the dialog, select Col(D) as <b>Independent Variables</b> and then click <b>OK</b>
<dl><dd> <a  class="image"><img alt="Nnr prediction.png" src="../images/Neural_Network_Regression/400px-Nnr_prediction.png?v=70349" width="400"   /></a></dd></dl></li>
<li> We can find the predicted Y values in the sheet <b>FitData</b>
<dl><dd><a  class="image"><img alt="Nnr predicted Y.png" src="../images/Neural_Network_Regression/600px-Nnr_predicted_Y.png?v=70351" width="600"   /></a></dd></dl></li></ol>
<h2><a name="Example_2:_Multiple_Linear_Regression"></a><span class="mw-headline">Example 2: Multiple Linear Regression</span></h2>
<p>We have three independent variables and one dependent variable, and want to study the relationship between them:
</p>
<dl><dd> <img src="../images/Neural_Network_Regression/math-dfb1bae906b0ec6cd6d4f5cd728b9dd0.png?v=0" title="y=a_{0}+a_{1}x_{1}+a_{2}x_{2}+a_{3}x_{3} " alt="y=a_{0}+a_{1}x_{1}+a_{2}x_{2}+a_{3}x_{3} " class="tex"/></dd></dl>
<ol><li> Switch to folder <b>2. Multiple Linear Regression</b> in the <b>Project Explorer</b></li>
<li> Activate Book6, click on the <b>Neural Network Regression</b> icon in the <b>Apps Gallery</b> to open the dialog</li>
<li> In the <b>Input</b> tab, set <b>Independent Data</b> to be Column A ~ Column C, <b>Dependent Data</b> to be Column D</li>
<li> In the <b>Options</b> tab, set settings as below. Then click <b>OK</b> to generate results
<dl><dd><a  class="image"><img alt="NNR MLR settings.png" src="../images/Neural_Network_Regression/400px-NNR_MLR_settings.png?v=70358" width="400"   /></a></dd></dl>
<ul><li> "3 5 4" is the number neurons in each hidden layer. We have three independent variables so it is good to have three hidden layers.  (The selection of an architecture for your neural network can only be done by trial and error. You can refer to <a class="external text" href="https://stats.stackexchange.com/questions/181/how-to-choose-the-number-of-hidden-layers-and-nodes-in-a-feedforward-neural-netw" target="_blank">the reference page</a> as a starting point.)</li>
<li> <b>Identity</b> is chosen as Activation Function as we are going to fit a linear model. </li>
<li> Set <b>K = 5</b> which means split the data sample into 5 groups for cross-validation. In cross-validation, each training data is treated as the test data, and is excluded from training data to judge which group it should be classified to, and then verify whether the classification is correct or not. </li>
<li> <b>Standardize Independent Variables</b> is set to be <b>Z scores...</b>. Use the option to make all the variables to be in the same scale during fitting.</li></ul></li></ol>
<h3><a name="Using_Results_in_Python_from_the_Trained_Model"></a><span class="mw-headline">Using Results in Python from the Trained Model</span></h3>
<p>Suppose the NNR result we got in last part is <b>Book2</b>. We have prepared new independent values in <b>column A ~ C'<i> of </i></b><i>Book1</i> and want to predict the new results from the model established in <b>Book2</b>
</p>
<dl><dd><a  class="image"><img alt="NNR Python.png" src="../images/Neural_Network_Regression/650px-NNR_Python.png?v=70370" width="650"   /></a></dd></dl>
<p>The Python codes below show how to predict dependent values for new independent values based on the trained model in <b>NNR</b> sheet. The python codes will read new input values from <b>column A ~ C</b> of <b>Book1</b> and put prediction results in <b>column D</b>
</p><p><b>Steps to run the codes</b>
</p>
<ol><li> Choose menu <b>View: Code Builder</b> to open <b>Code Builder</b></li>
<li> Choose menu <b>File: New</b> in Code Builder and create an empty Python file</li>
<li> Copy and paste the codes below to the Python file</li>
<li> Press <b>F5</b> to run it</li></ol>
<pre class="lt" style="font-family:monospace;">#The workbook with NNR result saved the neural network regression model
#Before running the code, you should activate the workbook 
from sklearn.<span style="color: #000080;">neural_network</span> import MLPRegressor
import originpro as op
import PyOrigin
import numpy as np
import sys

app_dir <span style="color: #000080;">=</span> PyOrigin.<span style="color: #000080;">LT_get_str</span><span style="color: #000000;">&#40;</span><span style="color: #ff00ff;">'%@A'</span><span style="color: #000000;">&#41;</span><span style="color: #000080;">+</span><span style="color: #ff00ff;">&quot;Neural Network Regression&quot;</span> #get App folder path
sys.<span style="color: #000080;">path</span>.<span style="color: #000080;">append</span><span style="color: #000000;">&#40;</span> app_dir <span style="color: #000000;">&#41;</span> # add App folder path to sys
import nnr 
model<span style="color: #000080;">=</span>nnr.<span style="color: #000080;">LoadRegressionModel</span><span style="color: #000000;">&#40;</span><span style="color: #000000;">&#41;</span> #get saved model from active workbook 

#after loading the model, specify the x data to predict
wks <span style="color: #000080;">=</span> op.<span style="color: #000080;">find_sheet</span><span style="color: #000000;">&#40;</span><span style="color: #ff00ff;">'w'</span>, <span style="color: #ff00ff;">'[Book1]Sheet1'</span><span style="color: #000000;">&#41;</span> #find the sheet with x to predict
x <span style="color: #000080;">=</span> wks.<span style="color: #000080;">to_list2</span><span style="color: #000000;">&#40;</span> <span style="color: #0000dd;">0</span>,<span style="color: #000080;">-</span><span style="color: #0000dd;">1</span>, <span style="color: #0000dd;">0</span>,<span style="color: #0000dd;">2</span> <span style="color: #000000;">&#41;</span>#wks.<span style="color: #000080;">to_list2</span><span style="color: #000000;">&#40;</span>r1,r2,c1,c2<span style="color: #000000;">&#41;</span>

wksTrain <span style="color: #000080;">=</span> op.<span style="color: #000080;">find_sheet</span><span style="color: #000000;">&#40;</span><span style="color: #ff00ff;">'w'</span>, <span style="color: #ff00ff;">'[MultipleLine]Multiple Linear Regression'</span><span style="color: #000000;">&#41;</span> #find the sheet with x to train
xTrain <span style="color: #000080;">=</span> wksTrain.<span style="color: #000080;">to_list2</span><span style="color: #000000;">&#40;</span> <span style="color: #0000dd;">0</span>,<span style="color: #000080;">-</span><span style="color: #0000dd;">1</span>, <span style="color: #0000dd;">0</span>,<span style="color: #0000dd;">2</span> <span style="color: #000000;">&#41;</span>#wks.<span style="color: #000080;">to_list2</span><span style="color: #000000;">&#40;</span>r1,r2,c1,c2<span style="color: #000000;">&#41;</span>

#if train data was standardized before fitting, you should also standardize x before prediction
#if not standardized, use default options
#nnr.<span style="color: #000080;">FormTrainData</span><span style="color: #000000;">&#40;</span>xpred, normalize<span style="color: #000080;">=</span><span style="color: #ff00ff;">'none'</span>, xTrain<span style="color: #000080;">=</span>None<span style="color: #000000;">&#41;</span>
#normalize<span style="color: #000000;">:</span><span style="color: #000000;">&#123;</span><span style="color: #ff00ff;">'none'</span>,<span style="color: #ff00ff;">'standard'</span>,<span style="color: #ff00ff;">'minmax'</span><span style="color: #000000;">&#125;</span>,default<span style="color: #000080;">=</span><span style="color: #ff00ff;">'none'</span>,<span style="color: #ff00ff;">'standard'</span><span style="color: #000000;">:</span>Z score, <span style="color: #ff00ff;">'minmax'</span><span style="color: #000000;">:</span>normalize to <span style="color: #000000;">&#40;</span><span style="color: #0000dd;">0</span>,<span style="color: #0000dd;">1</span><span style="color: #000000;">&#41;</span>

x_pred<span style="color: #000080;">=</span>nnr.<span style="color: #000080;">FormTrainData</span><span style="color: #000000;">&#40;</span>x,<span style="color: #ff00ff;">'standard'</span>,xTrain<span style="color: #000000;">&#41;</span> #transform x data into proper data format, standardized by train data
y_pred <span style="color: #000080;">=</span>model.<span style="color: #000080;">predict</span><span style="color: #000000;">&#40;</span>x_pred<span style="color: #000000;">&#41;</span>#predict y

wks.<span style="color: #000080;">from_list</span><span style="color: #000000;">&#40;</span> <span style="color: #0000dd;">3</span>,y_pred,<span style="color: #ff00ff;">'Predicted Y'</span> <span style="color: #000000;">&#41;</span>#output predicted y</pre>


